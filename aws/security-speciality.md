# How IAM is used to securely manage access 
Identity and Access Management 
- Authorization: what can be accessed, once account is authenticated 
- access control: method of accessing secure resource 
- manage, control, govern authentication, authorization, and access control w/n AWS account 
## Features 
- on the dashboard, has sign-in link for users, and the ability to customize it
- resources
- best practices: AWS offers a list of best practices (doesn't show anything in govcloud)
- groups: assign policies to users. Not necessarily used to allow access in and of themselves 
- roles: operate similar to users, but designed to be assumed to identity or service to have access to temporary permissions 
- policies: written in JSON, defines what can and can't be accessed
    - assigned to users, groups, roles 
    - AWS managed policies 
    - customer managed policies 
        - inline policies 
- access management > account settings 
    - lists the password policy 
    - lists security token service endpoints 
        - recommended to disable the endpoints that aren't used 

# Managing User Identities with Long Term Credentials in IAM
## Overview of the User Dashboard 
- Users: objects representing an identity 
    - user overview
        - last activity 
            - green check: <90 days since last access 
            - orange triangle: 91-365 days since last access
            - red triangle: >365 days since last access
            - helps to ensure unused user accounts aren't hanging around 
        - path: location of user, especially for larger orgs with layers of user management 
        - mfa: listed if it's enabled
        - arn: unique identifier of the IAM user 
- secret keys: access key id, secret access key

# Managing Access using IAM User Groups & Roles 
## Manaing Multiple Users w IAM User Groups
- can't be directly referenced as a principal in a policy; allow access to users w/n group
- usually ment to align with teams and permissions the team needs, e.g., developers, admins 
    - avoids updating policies assigned directly to each user
- soft limit of 300 groups
- each user can only be added to 10 groups 
## IAM Roles
- allow trusted users, aws services, and applications to get temporary credentials to access resources 
- can be assumed by different identities when required 
- do not have long-term credentials (like password or access keys)
- uses trust relationship that defines who or what can use the role 
- assumption rules
    - user in same acct
    - user in diff acct
    - aws service
    - external federated user 
## Using AWS services roles to access AWS resources on your behalf
- service roles
    - commonly used on ec2 instances to use other resources 
    - role can be assigned at creation or while instance is running 
    - using roles is far superior to having access keys stored on the instance 
- service-linked roles 
    - often created first time a service is used
    - preconfigured by AWS to include the resources it needs access to
        - e.g. AWSServiceRoleForAmazonSSM
            - has AWS managed Policy configured, which cannot be accessed 
            - specifically designed to provide access to AWS SSM
## Using IAM User Roles to Grant Temporary Access for Users 
- when a role is assumed, it temporarily REPLACES all other permissions the user has 
- when creating a role, can use 'AWS account' within the current environment, rather than having to have a trust relationship w ec2; just use the account ID of the current account 
    - then add an inline policy to the user to assume that role
    - often used to allow cross-account, but works w/n account too
## Using Roles For Federated Access
- allows authentication from web identity or SAML 2.0 federation
    - web identity federation
        - federation: two provides have a level of trust where one party is the identity provider (IdP) and service provider (SP)
        - irl, like signing in with facebook/google/apple 
        - authentication token provided from IdP, and then the role is assumed and user able to be authenticated 
        - AWS Cognito best way to do it with mobile apps 
    - SAML 2.0: (security assertion markup language)
        - generally meant for authenticating employees, e.g. if using MS AD
        - minimizes amount of admin use & allows for single sign-on
        - can pick b/w programmatic access and programmatic and gui access 

# Using IAM Policies to Define and Manage Permissions 
## IAM AWS Policy Types
- identity-based policies
    - attached to users, groups, roles
    - managed
        - saved to policy library,
        - able to be attached to multiple entities 
        - aws-managed policies
        - customer-managed policies 
    - inline
        - embedded directly to entity; only exists w/n entity
        - can't easily be attached to other entities 
        - not usually best practice; requires additional administration effort
- resource-based policies
    - attached inline to resources (e.g. trust policy)
    - inline policies assigned to a resource instead of an entity, e.g. S3 bucket policy 
    - must have principal defined w/n the policy
- permission boundaries
    - can only be associated w role or user; define max level of perms that can be granted
    - act as guide-rail for max permissions allowed 
- organization service control policies (SCPs) (used by AWS organizations)
    - similar to permission boundaries, at account level
    - define boundary of max permissions
    - associated w aws account or account OU
    - does not allow access, only acts as a guide-rail
## Examining the JSON Policy Structure
- (JavaScript Object Notation)
- version: specifies policy language version & language syntax used
- statement: defines main elements of the policy
    - must contain at least one statement, or can contain an array of statements 
- sub-elements 
    - sid: set a unique identifier w/n statement 
    - effect: grant or reistrict access for the actions defined in the statement 
    - principal: defines which principal the policy relates to
        - not needed for identity-based policies
    - NotPrincipal
    - action: action that will either be allowed or denied, depending on value entered for 'effect'
        - based on the APIs & actions associated with the AWS services 
    - NotAction
    - resource: specifies actual resource action & effect to be applied to using ARNs
        - usually arn:partition:service:region:account-id:resource 
            - partition is aws or aws-us-gov
            - region left blank for services that are global
    - NotResource
    - condition (optional): control when permissions will be effective based upon set criteria 
## Policy Evaluation Logic 
- every request for permissions is evaluated through a list of steps 
    - authentication: ensure principal is authenticated as valid
    - context: what service or action is being requested
    - policy evaluation: determine level of access 
    - result: AWS determines if access is allowed or denied 
- policy evaluation
    - by default, all access denied
    - only allowed if an allow has been associated with a policy attached to a principal
    - if a deny is associated with the principal at any point, access denied
    - explicit deny will always take precedence over allow 
    - checks organizational SCPs, then resource-based policies, IAM permission boundaries, and finally identity-based policies 

# The Difference Between Authentication, Authorization, and Access Control in AWS 
## Authentication
- requires two parts of information
    - identification: unique value in aws account to authenticate to
        - can't have two of the same username in the same account 
    - verification: verify identity by providing password 
## Authorization
- takes place once an identity has been authenticated
- establishes what level access the authenticated entity has 
## Access Control
- logical access controls 
    - username/password authentication method
    - username/password method + MFA
    - basically, what access methods are required to access a resource 
    - use of roles or federation to provide permission
    - NACLs/SGs
    - related to authentication & authorization

# Authorization Controls in AWS 
## IAM
- best practice: attach policies to groups and add users to groups 
- customer-managed policies can help ensure least priviledge vs using AWS managed policies 
    - able to 'import managed policies' when creating a customer-managed policy to modify AWS managed policies and customize them
- can separate actions in policies with commas 
## S3
- IAM authorization
    - S3 Bucket Policies
        - only applied to buckets w/n s3; act as resource-based policies 
        - when applied, affects all objects in bucket 
        - ACL bucket policy principals - can be users, federated/IAM, aws acct or aws services
        - allow setting conditions w/n policy
            - e.g. restrict based on IP address 
    - S3 ACLs
        - able to set different permissions per object 
        - set at bucket or object level
        - conditional statements not supported
        - less granular than bucket policies 
        - able to add canonical ID of another account allowed to access bucket 
- permission conflicts are based on the principle of least privilege
    - if there is a single deny anywhere in the permissions, access is denied 
## NACLs
- authorize network traffic w/n vpc at protocol and subnet level
- can be applied to one or multiple subnets
- default NACL allows all traffic in/out
- NACL rules
    - rule number: acl rules are read in ascending order
        - sequence rules with organized numbering system and leave ~50 spots b/w each
    - type: select a protocol type from dropdown list
    - protocol: provides value for custom rules
    - port range: specify port range for protocol
    - source: define specific IPs or allow all 
    - allow/deny: what to do w traffic
- stateless; need an inbound rule to allow responses to outbound requests
## Security Groups 
- associated with instances, filter traffic into/out of instance
- NO DENY action for rules 
- stateful: don't need an inbound rule to allow traffic in 
- AWS SG rules fields
    - name: up to 255 characters
    - security group rule ID
    - ip version: 4/6
    - type
    - protocol: for custom rules
    - port range
    - source: sg, subnet, ip address allowed
    - description 

# AWS Authentication Mechanisms
## Username/Password & MFA
- usernames must be unique w/n the account
    - usernames verify identity
- password can technically be the same between every user
    - passwords provide verification of identity 
- username/password alone not considered very secure
- MFA: user must use second step of authentication after submitting password 
    - no extra charge to use this service
    - must be configured and associated with the user 
## Programmatic Authentication
- access via CLI, APIs, powershell, SDKs
- access keys composed of
    - access key ID: 20 random uppercase alphanumeric characters (A-Z, 0-9)
    - secret access key: 40 random upper/lowercase alphanumeric and non-alphanumeric characters 
- access keys can be created for any user that needs programmatic authentication 
- not possible to retrieve lost security keys 
- after creation, must be associated with system/application that will use them \
- rotating access keys decreases the possibility of the keys being compromised
    - process
        - create a second key
        - download new access keys
        - associate keys with application (e.g., aws configure to add new credentials)
        - mark existing access keys as inactive
            - test to make sure the new keys work
        - delete old keys 
- for instances (and probably in general) better to use roles 
## IAM Roles
- efficient & secure solution in authenticating & authorizing access 
- avoids embedded credentials w/n app 
- simply an object with a list of associated permissions 
- temporary access keys are provided when roles are assumed
- permissions from user and role are NOT amalgamated - the role TOTALLY takes over 
## Key Pairs
- made up of public and private keys
    - either ED25519 OR 2048-bit SSH-2 RSA
        - ED25519 doesn't work for instance connect or windows instances 
- on windows instances, decrypts the admin password
- on linux instances, enables ssh connection 
## Federation 
- allows users authenticated by external IdPs to access AWS 
- trust relationship b/w IdP and AWS account is established 
    - OpenID (e.g. facebook/google/apple login)
    - SAML 2.0 (e.g. MS AD)

# Using AWS Identity Federation to Simplify Access at Scale 
- identity federation: method where two identity providers can establish a level of trust 
    - identity provider (IdP) authenticates identity, and service provider gives authorization based on credentials 
    - often correlates with SSO
    - assertion: contains metadata and attributes about user such as username
        - sent from IdP after user authenticates their identity to the service provider 
        - allows service provider to grant access to their services 
- OAuth 2.0, ODIC (OpenID Connect), SAML 2.0 (Security Assertion Markup Language)
    - OIDC: simple identity layer on top of OAuth 2.0
- services offered by AWS
    - AWS SSO (now succeeded by IAM Identity Center)
        - allows creation of SSO approach to access multiple AWS accounts w/n AWS organization using a single IdP
    - AWS IAM
        - supports federated access via OpenID or SAML
    - Amazon Cognito 
        - simplify user access to mobile or web app using SAML or web identity federation 
        - able to scale to million so of users 
        - able to create a custom portal for users to see when signing in 

# AWS Incident Response: Isolating your EC2 instances 
- containment is a critical part of incident response 
- ought to have an incident response playbook before problems occur 
- isolation: limiting visibility of instance to itself and other instances
- detection mechanisms
    - Amazon GuardDuty: continuous monitoring of vpc flow logs and metadata
        - able to identify instances that are mining crypto or serving malicious traffic 
    - Amazon Inspector 
- how should one isolate EC2 instances 
    - SG isolation
        - easy to add SGs to instances & limit traffic
        - to keep in mind
            - have to explicitly allow traffic
                - most permissive security group rules WILL BE ALLOWED
            - CANNOT SHUT OFF TRAFFIC to an instance by adding an SG; would have to remove all the SGs before adding a blocking SG
                - since they are stateful, can allow traffic back in the network 
                - tracked vs untracked connections 
                    - untracked connections, e.g. 0.0.0.0/0, where all traffic/ports are allowed in/out
                        - when an SG is updated, e.g. rule added, removed, updated, or sg deleted, this traffic is interrupted
                    - tracked connection, e.g. allowing a specific port from a specific IP or CIDR rule
                        - traffic will not be immediately interrupted when SG is updated 
                        - still technically possible for a malicious user to be connected to the instance, with a tracked connection, the SG change to block all traffic in, and that user to remain connected. They wouldn't be able to reconnect, but they wouldn't be forced to disconnect 
                            - to remove tracked connections
                                - created dedicated 'isolation' SG
                                - create single rule of 0.0.0.0/0 for all traffic in both inbound & outbound rules
                                - remove any existing security groups attached to the instance 
                                - associate the isoluation SG to the instance 
                                - delete both inbound and outbound rules from the isolation SG
                                - result: converts all tracked connections into untracked connections & blocks everything 
    - NACL isolation 
        - all rules based on external IP addresses or CIDR blocks, can't block traffic w/n env
        - only one allowed per subnet 
        - very easy to stop inbound/outbound traffic
            - only need one rule per allow and deny to block all traffic 
        - can't be used in a targeted way 
        - how to
            - add deny all rule to inbound & outbound rules as the first rule 
    - Route Table Isolation
        - to disable access to outside, remove all routes in route table or create a new, empty route table
            - disables all external subnet communications, HOWEVER subnets would still be able to communicate w/n VPC
    - Internet Gateway Isolation 
        - can't be removed from VPC if there's any dependencies in the VPC 
            - requires turning off all instances 
        - only real option would be to remove routes to route table 

# AWS CloudTrail: An Introduction 
- used to track and audit all API calls in an account 
## What is AWS CloudTrail
- records & tracks all API requests in AWS account
- every API requestcaptured as an event
- multiple evens recorded w/n CT logs
- events contain array of associated metadata 
- new log files created every 5 minutes
    - delivered and stored w/n S3
    - can also be delivered to CloudWatch logs for metric monitoring & alerting w SNS
- CT Infrastructure 
    - global service
    - supports 60+ AWS services/features 
- use cases for captured data
    - effective for security analysis
        - monitor restircted api calls
    - resolve day-to-day operation issues 
    - track changes to AWS infrastructure (AWS Config helps with this as well)
    - CT logs can be used as evidence for compliance and governance controls (ISO, PCI DSS, FedRAMP)
## How AWS CloudTrail works
- Core features & services
    - trails: building blocks of the service
    - s3
    - logs: created by CT & capture events every 5 minutes & delivers to bucket 
    - kms: enable encryption
    - SNS: notify when different actions occur 
    - CW logs: deliver logs for metrics monitoring
    - event selectors: select what part of events to capture
    - tags
    - events: tracked in CT log file
    - API activity filters: events are stored in console for 7 days 
- CT process flow
    - create a trail (so CT knows which apis to track)
    - specify s3 bucket for log storage
    - optional: encrypt log files w kms
    - optional: sns notifications of new log files
    - optional: enable log file validation
    - trail created
    - post creation config
    - option: deliver CT to CW for monitoring
    - optional: configure event selectors
    - optional: add tags
    - configuration complete
    - after config, use API activity filter
- lifecycle of API call in CT
    - API call captured if it matches trail and stored in log file
    - sends to s3 or cw logs
    - in s3, stored in default s3 sse 
        - s3 lifecycle policies may apply 
## Understanding AWS CloudTrail Permissions
- Granting Access to CT
    - required proper permissions & authorization to use CT
    - create customer-managed or use AWS managed policies
        - AWS managed policies available are full access or read only access 
            - full-access also includes full access to sns and s3 
- s3 bucket policy 
    - specify bucket for CT logs
        - create new s3 bucket
            - CT configures and applies bucket policy w relevant permissions allowing logs to be delivered to bucket 
        - use existing s3 bucket
            - customer must configure and set up permissions
- CT & KMS
    - specific permisssions req'd to decrypt logs
    - adds another layer of encryption to CT logs files 
    - SSE-KMS can be chosen when creating trails
        - two options
            - create new KMS key (aws applies proper perms)
            - use existing keys (must create own policy; must be in same region as CT)
                - user will need decryption permissions 
## Understanding Trails
- w/o a trail, CT unable to capture API calls
- Trails hold all config information for capturing API calls 
## Insight into AWS CloudTrail Logs 
- what is a log file? 
    - written in JSON
    - new event written for each API call
    - new log file created every 5 minutes
    - log files delivered to s3 ~15 minutes after API call was initiated 
- events in a log file 
    - eventName: name of actual API that was called
    - eventSource: service which API call was made against 
    - eventTime
    - SourceIPAddress: of the requester who made API call
    - userAgent: method request was made through
        - signin.amazonaws.com (user in AWS console)
        - console.amazonaws.com (root user)
        - lambda.amazonaws.com 
    - userIdentity: set of attributes about identity that made request
- log file name convention
    - AccountID_CloudTrail_RegionName_YYYYMMDDTHHmmZ_UniqueString.FileNameFormat
        - time in utz
        - unique string is 16 digit alphanumeric character
        - default filename is json.gz 
- s3 bucket folder structure
    - BucketName/prefix/AWSLogs/AccountID/CloudTrail/RegionName/YYYY/MM/DD
        - prefix is optional to aid w organization
- multiple accounts and multiple logs 
    - CT logs from multiple accounts can be aggregated to same bucket
    - can't do the same w CW logs 
- log aggregation process
    - create new Trail in primary AWS acct
    - apply perms to S3 bucket allowing cross-acct access 
    - create new Trail in second AWS accts using Bucket name from primary AWS acct
        - AWS will give a warning; make sure to use the same name & prefix
    - create Trail & logs will be delivered to same S3 bucket in primary AWS acct 
- accessing cross-acct log files
    - if other accounts want read access, use roles in the primary aws acct and give users in other accounts ability to assume the roles
- log file integrity
    - verify log files have remained unchanged since CT delivered to S3 bucket
    - configured during Trail creation
- log file integrity process
    - hash created for log file by CT
    - CT creates new digest file every hour to verify logs have not changed
    - digest files contain detail of all logs delivered w/n last hour 
    - to verify the integrity, public key of log is used 
    - can only be done via CLI 
    - stored under different prefix than rest of CT logs 
## Montoring with AWS CloudTrail
- CloudWatch allows any event from CT to be monitored 
    - e.g. monitoring major changes in SGs, instance creation/stoppage/rebooting unexpectedly, changes to policies in s3 + IAM, monitoring failed login attempts to management console, API calls that result in failed authorization 
- CT + CW
    - to deliver logs to CW, Trail must be config'd to use CW
    - to deliver to CW, needs a role to be able to make CW logs logstream
- CW config
    - have a size limitation of 256KB
    - add metric filters to allow search of the logs 
    - each metric filter requires filter pattern
        - filter patterns determine what data CW is monitoring

# AWS Config: An Introduction 
- config: management tool service 
## What is AWS config
- Resource Management 
    - important to understand what resources are being used, any security vulnerabilities to worry about, how resources are linked w/n the environment, change history of resources, is infrastructure compliant with internal/external controls, is accurate audit info available 
- what can AWS config do
    - capture resource changes (within configuration items (CI))
    - act as resource inventory
    - store configuration history; able to save history of changes against a resource 
    - provide a snapshot of configurations (along with metadata)
    - notify about changes to resources
    - provides AWS CT integration 
    - use rules to check compliance 
    - perform security analysis w/n env 
    - identify relationships between resources 
- AWS Config & regions
    - regional service; must be configured per region 
    - able to also include global services 
## Key Components
- AWS Resources
    - typically classed as objects that can be created, updated, or deleted
    - config records state of resources in specific region
- Configuration Items
    - json file holds config and relationship information, among other info like metadata about a resource 
    - records CIs for directly related resources as well 
    - five sections
        - metadata: info about CI itself 
            - version & config ID
            - MD5Hash for comparision
            - time of capture and state ID
        - attributes: info about resource
            - unique resource ID
            - key-value tags
            - resource types 
            - ARN 
        - relationships
            - description of relationships to other resources 
        - current configuration
            - displays info from describe or list calls from AWS CLI
        - related events
            - displays related CT event ID
                - helps dive into 'who' 'what' and 'when'
    - used by configuration history, streams, and snapshots 
- Configuration Stream (CS)
    - when new CIs are created, sent to CS & sent to SNS
    - other events CS used for
        - configuration history files delivered
        - configuration snapshots started
        - state of compliance changes for a resource
        - evaluations begin 
        - when AWS Config fails to deliver notifications 
    - SNS can have different notification endpoints
        - email, SQS
            - can be spammy on email 
- Configuration History
    - uses CIs to produce a history of changes for a resource
    - able to see changes over time on a resources
    - able to view in console or CLI 
    - typically delivered every 6 hours to S3 
- Configuration Snapshot
    - takes point in time of all supported resources configured for that region & creates CIs for each resource 
- Configuration Recorder
    - responsible for recording all changes of resources and generating the CIs 
    - can be stopped/started
        - when stopped, doesn't track changes to resources 
- Config Rules
    - enforce specific compliance controls across resources
    - each rule is essentially a lambda function that looks at resources and checks compliance against rules. Sends a message to SNS & marks resource as non-compliance
        - non-compliant resources operate as normal, and it's up to user/admin to take the action
    - able to use predefined list of AWS Managed rules & able to define custom rules 
    - highly recommended for maintaining security checks & configurations 
    - when first enabled, it's likely to see a bunch of resources as noncompliant 
    - soft limit of 50 rules per region 
- Resource Relationships 
    - config identifies relationships b/w resources, e.g. which instances use what volumes 
- SNS Topic
    - used as configuration stream for notifications 
    - best practice is to programmatically analyize results in SQS before sending to SNS
- S3 bucket
    - used to store all Config History files and Snapshots 
- Permissions
    - IAM role is req'd to allow config to obtain the correct perms to interact w other services, e.g. reading resources, writing to S3 
- summary
    - configure the elements for the Configuration Recorder
    - AWS config discoveres all supported resources
    - for any change on a resource, a CI will be created and a notification is sent
    - AWS config checks current config rules to evaluate if the change is noncompliant
    - if a configuration snapshot is taken, AWS config will create a snapshot and delever to specified S3 bucket
    - after 6 hours, a configuration history file will be created 
- demonstration
    - able to send Configuration History reports to an S3 bucket in another account, and SNS notifications can go to a topic in another account 
## Service Integration
- integrates w SNS, SQS, S3, CloudTrail, IAM
    - SNS: used for configuration stream for CI
        - multiple accounts can subscribe to same topic in a primary AWS acct 
    - SQS: can subscribe to Configuration Streams for HA and decoupled apps + data extraction 
        - can perform custom filtering
        - can be subscribed to multiple Configuration Streams 
    - S3: used to store CI w/n single bucket
        - can contain configuration history and snapshots
    - AWS CloudTrail
        - integrates w config at CI level 
        - the CT data can be seen w/n config console on the event 
            - also stored in CT 
        - also tracks some APIs from AWS config 
    - IAM
        - role required to give permissions to service to publish data to SNS/S3 
        - config must be able to describe list and get API calls on resources it monitors 
## Managing Compliance with AWS Config
- compliance sources
    - come from different resources, e.g. HIPAA, internal security controls, internal standards
- config rules
    - manage and organize compliance for env
    - acts as automatic compliance checker 
    - AWS Managed Rules
        - cover a variety of best practices 
        - can be edited to match env requirements 
    - notifications are sent allowing appropriate actions to be taken
        - reesolve security issue
        - identify who/what made the change
- creating/modifying rules
    - identify compliance and standards
    - define requirements from all parties 
## AWS Config Use Cases 
- security compliance 
    - enforce strict compliance rules
    - notifications of noncompliance 
    - continually monitoring resources 
- discovery of resources
    - once started, config will discover all supported resources 
- audit compliance 
    - external governance controls: FERPA, HIPPA, PCI DSS, SOC
    - setting custom and managed rules to stay in compliance
    - able to prove history of changes
- resources change management
    - helpful to understand change of resources upon other resources 
- troubleshooting & problem management
    - using config dashboard, able to see timeline of events and go back before an incident happened and see what occured beforehand 

# Amazon Inspector 
## What is Amazon Inspector?
- helps identify security vulnerabilities w/n EC2 instances and apps 
- automatically achieved using assessments based on hundreds of best practices and known security weaknesses
    - common vulnerabilities and exposures (CVE)
    - center for internet security (CIS) benchmarks 
    - security best practices
    - runtime behavior analysis 
- when assessment complete, report is generated 
- service is agent based; requires software to be installed on instances that should be assessed 
- rule package customization
    - able to select which packages are best for use case
- why use it? 
    - security breaches on the increase
    - targeting small and large companies 
- security in the cloud
    - security is one of the top reasons why organizations are slow to adopt cloud tech
    - AWS invests a lot into security
- why use inspector'
    - increase confidence in level of security built into apps and services
    - confidence benefits orgs and customers
    - inspector cross-checks resources for security compliance, threats, and vulnerabilities, reducing exposure attacks 
## Components of Amazon Inspector
- amazon inspector role
    - required to create or select role to allow inspector to have read only access to all ec2 instances
- assessment targets
    - group of instances that assessment is run against 
    - uses tags to define groups of assessment targets 
        - only a match of one key is necessary in a list of multiples 
- aws agents
    - software agents installed on instances that are meant to be monitored
    - can track and monitor data across the network, along w file system and any process activity of instance
    - telementry data fed to inspector service over TLS
    - regular heartbeat sent from agent to inspector, which service will respond to w instructions
    - agent updates are managed & automatically installed by AWS 
- assessment templates
    - define specific configurations as to how an assessment is run on instances 
    - configurable items
        - rules packjaged to be used
        - duration of assessment: 15m/1h/8h/12h/24h. 1h recommended by AWS
        - SNS topics: can be configured to notify about an assessment run
        - inspector-specific attributes to be assigned to findings 
        - CANNOT be modified after creation
- rule packages
    - contains a number of individual rules that are each checked against instance metadata when assessment is run
    - each rule has an associate severity
        - high
            - should be rectified immediately 
            - would likely compromise the integrity, confidentiality, and availability of data 
        - medium
            - should be rectified in a timely manner
            - poses a risk to integrity, confidentiality, and availablility of data
        - low
            - log urgency on remediation, but still requires attention
        - informational
            - describes a particular security config w/n assessment target 
    - CVE
        - rules w/n package will check for exposures to known security holes that would compromise CIA of instance
        - aws updates this list w new CVEs when they're available
    - CIS
        - global standard for protecting data and resources 
        - AWS is a CIS benchmarks member company 
    - security best practices 
        - looks for weaknesses in common security best practices
        - can ONLY be run against assessment targets that are running Linux 
        - covers the following checks
            - disable root login over SSH
            - support SSH version 2
            - disable password auth over SSH
            - configure password maximum age/minimum length/complexity
            - enable ASLR
            - enable DEP
            - configure perms for system dirs (e.g. only root has access to / dir)
- Assessment Run
    - occurs once inspector role configured, agents installed, assessment target config'd, assessment template config'd
    - telemetry sent back to inspector and s3 to assess data against rules packages
    - multiple assessments can be run if they're not overlapping instances
- telemetry
    - data collected from instance, detailing config, behavior and processes during assessment run
    - once collected, sent to inspector in near-real-time & stored in s3
    - s3 data encrypted & deleted after 30 days
- assessment reports
    - provides details on what was assessed and the results of that assessment
    - findings report
        - contains subset of full report
        - summary of assessment
        - list of instances assessed
        - rules packages used
        - detailed report on findings that occured
    - full report
        - everything in finding report plus 
        - list of rules that were passed successfully for all instances 
- findings
    - generated from results of assessment run
    - a potential security issue or risk against instance
    - for each finding an explaination of the issue is provided 
## Integraztion with CloudWatch & CloudTrail
- cloudwatch
    - able to monitor agents and assessment runs 
- cloudtrail
    - all API calls performed by inspector are logged w/n CT
## Service Limitations and Costs 
- max 500 agents per assessment - hard cap
- max 50,000 assessment runs per account - soft cap 
- max 500 assessment templates - soft cap
- max 50 assessment targets - soft cap 
- cost 
    - based on number of instances scanned, specifically the amount of time, per month - charged per instance 

# AWS Trusted Advisor
## What is AWS Trusted Advisor
- helps optimize inffrastructure
- helps in making decisions based on best practices 
- main function: recommend impreovements across AWS account to optimize and streamline account
    - cost optimization
    - performance
    - security
    - fault tolerance 
    - service limit 
        - warns when resources reach 80% of service limit quota
- has a list of control points and checks to see if account is lined up with best practice 
- acts as automatic auditor across account 
- 115+ best practices checks    
    - list of available checks is based on support agreement w AWS
        - full access is provided with business and enterprise accounts 
            - also able to track most recent changes to AWS account + display at top of dashboard
    - security has 6 core checks available to all tiers 
- features available to everyone
    - trusted advisor notification
        - opt-in or opt-out feature that tracks resource check changes and cost saving estimates over the course of a week & emails 3 people
    - exclude items
        - exclude specific resources from appearing in console w/n specific check 
    - action links
        - hyperlinks associated w many of the items w/n checks + allow quick access to resource in question
    - acces management
        - tightly integrated to IAM; full-access, read only, restrict access to specific categories, checks, and actions 
    - refresh
        - data is automatically refreshed if data is more than 24 hours old
        - can perform manual refresh 5 minutes after the last refresh
## Reviewing Checks & Taking Action 
- dashboard
    - shows the five categories & three icons under each category 
        - if icons are grey, no checks have met an alert criteria to activate the icon (e.g., to low of an account level for scans to occur)
- for each check, there's four bits of information
    - description and use
    - alert criteria
    - recommended action: high-level suggestion on steps & action to rememdiate
    - additional resources 
- security checks
    - security groups - specific ports unrestricted
        - assesses SGs to see if there's unrestricted traffic allowed (e.g. from 0.0.0.0/0)
        - able to exclude SGs from the check in the TA console 
    - IAM use
        - checks if using IAM service (rather than just root)
    - MFA on root account 
        - logging in as root account should have add'l levels of authentication 
        - helps protect AWS account 
    - Amazon EBS Public Snapshots
        - checks if any snapshots are public
        - if snapshots are public, other folks would be able to view any data w/n if it's not meant to be public 
    - Amazon RDS Public Snapshots
        - checks if any RDS snapshots are public
- service limit checks 
    - checks w/n category assess when service limit reaches 80%
    - doesn't support every service 

# Understanding Amazon GuardDuty
## What is Amazon GuardDuty
- regional-based intelligent threat-detection service
    - users can monitor account for unusual behavior from CT event logs, VPC flow logs, DNS logs 
    - powered by ML
        - can identify behavior-based issues
        - best pracitces
        - blocking from known bad sources
    - provides auto and continuous security analysis
    - findings are sorted by severity
- doesn't require agents or software on resources
- can link multiple AWS accounts
## Components and Configuration
- data sources
    - CloudTrail Event logs
        - generated by CT, about API calls 
    - VPC flow logs
        - store network traffic info w/n VPC; in & out
    - DNS query logs    
        - contain queries that DNS resolvers forward to R53
        - contain requested domain, timestamp, record type, response code 
- machine learning 
    - gets better as time goes on & a baseline is able to be established
- list management
    - upload lists of trusted IPs and threats 
    - can only have ONE active trusted IP list at a time
    - may have 6 active threat lists 
    - only need to provide name of list, S3 location, and data format 
- GuardDuty Findings
    - found threats are listed as a finding w/n GD dashboard 
    - findings elements 
        - finding summary
            - finding type, severity, region, account ID, resource ID, time of detection, which threat list was used (if applicable)
        - resource affected
            - provides info about affected resource in detected threat
        - action
            - info about action that resulted in threat
        - actor
            - data relating to source of threat (IP, geographical info, port, domain)
        - add'l information
            - info on which threat list was used to detect threat 
            - if activity considered to be unusual
    - severity
        - each finding associated w severity level & score
            - high: 7.0-8.9
                - assumes security breach has occured & must be addressed immediately
            - medium 4.0-6.9
                - GD has detected suspicious activity that could escalate into a threat
            - low 0.1-3.9
                - issues that were detected, and may need to be addressed to prevent from occuring again 
## Managing Multiple Accounts
- able to have one account act as master and all other accounts as members & view findings in central location
- trusted IP lists and threat lists w/n member accounts are not used w/n master account
- master account give added controls like suspending GD w/n member accounts
    - able to suspend GD, but can't disable
- setup
    - add AWS account from w/n master account
    - send invitation to member accounts
    - accept inveitation from w/n member account 
        - can only accept one invitation 
## Managing Permissions
- access GD dashboard
    - perms req'd to access dashboard & enable GD
- enable GD
    - user needs access to GD & IAM perms to allow GD to have the proper service-linked role 
    - policy for user to use GD is AmazonGuardDutyFullAccess 
        - doesn't allow adding the lists, user must be able to do a couple more IAM things 
        - AWS has a template of a policy that allows true full access, but it's not managed 
        - AmazonGuardDutyReadOnlyAccess provides read-only perms for users to review findings 
        - GD uses AWSServiceRoleForAmazonGuardDuty when GD enabled 
- manage trusted IP & threat lists
## Understanding Amazon GuardDuty Findings
- in the finding, can filter by clicking on the magnifying glass with the +, and it adds it to the filter bar 
    - can save filters 
## Benefits to the Enterprise
- intelligent threat detection service that performs continual and automatic analysis and threat detection 
    - powered by ML, utilizes multiple threat detection feeds
- high-level security regardless of deployment size
    - provides same level of detection w/n global enterprises and small-scale deployments
    - implementing threat detection system in traditional env is very costly
    - minimal cost to observe all instances
- centralized management
    - aggregate findings into single master account
    - makes management easier
- no agents required
- no upfront costs
    - only pay for processing of log files 
    - click 'enable' and it starts working
- automation of rememdiation
    - can use CW event rules in conjunction w lambda 
    - able to trigger auto responses & quickly lock down resource by restricting permissions 
## Costing
- CloudTrail Event Analysis
    - per 1 million events/mo
- VPC flow logs and DNS log analysis
    - per GB of log analyzed per month
- able to use service free for first 30 days & see how much it would have cost to help estimate ongoing cost 
## Partner Offerings 
- vendors that focus on monitoring and security and provide services that interact with GD 
- Alert Logic Cloud Insight Essentials for AWS
    - allows gaining add'l insight into GD findings
    - helps respond to findings faster by providing further intelligence about threat
    - produce reports to analyze threat detection findings 
- CrowdStrike
    - integrate their threat intelligence feeds used w/n CW to GD
    - GD can pull data + info from CS which uses AI
- Trend Micro
    - Deep Security agent software that can be installed on EC2 to protect against threats
    - uses CW + lambda triggers to invoke Deep Security
- These are just a sample of the partners 

# Amazon Macie
## How to Find PHI and Sensitive Data in Your S3 Buckets with Amazon Macie 
- Macie: managed ML pattern matching service that helps with data security and privacy 
- can find PII and protected financial information
- able to take actions with lambda & step functions
- constant discovery of data w/n S3
    - creates service-linked role to
        - create inventory of S3 buckets
        - provide statistical data
        - monitor and evaluate buckets
        - check buckets for sensitive data 
- saves metadata and calculates statistics to make assessments of data
- can check for unencrypted buckets, publicly accessable, and shared buckets
- metadata automatically refreshed once every 24 hours
    - can be manually refreshed every 5 minutes 
- bucket policy findings
    - when Macie finds something, it creates a policy finding to be reviewed 
    - S3BlockPublicAccessDisabled
    - S3BucketEncryptionDisabled
    - S3BucketPublic
    - S3BucketReplicatedExternally
    - S3BucketSharedExtnerally
    - each finding includes severity rating, general information, and available for 90 days 
    - able to view findings in Macie Console, Macie API, AWS EventBridge, AWS Security Hub 
- since findings can be discovered programmatically, changes can be made auotmatically
### How to Discover Sensitive Data Within Buckets 
- create and run snsitive data discovery jobs
    - able to analyze objects in buckets for sensitive content
        - financial information
        - personal information
        - national information
        - medical information 
        - credentials and secrets 
    - report sensitive data & overall analysis
    - can be scheduled to run once, daily, weekly, etc 
    - managed data identifiers
        - built-in set parameters
        - curated and built by AWS
        - currently list defined by GDPR, HIPAA, PCI DSS, etc
    - custom data identifiers
        - created by customer
        - can include regex, severity data
        - can be used to supplment managed data identifiers 
- findings categorized by what bucket they were in and how they were found 
    - able to suppress findings as needed
### analyzing encrypted objects
- Macie can decrypt objects with the role, based on the encryption used
    - e.g., can decrypt SSE-S3, SSE-KMS fairly easily
    - for CMK-KMS, needs permission to the key 
    - cannot decrypt SSE-C
        - can only report metadata on object
    - cannot decrypt client side encryption
### Supported file formats
- big Data
    - .avro, .parquet
- compression/Archive
    - .gz, .gzip, .tar, .zip
- documents
    - .doc, .docx, .pdf, .xls, .xlsx
- text
    - .csv, .htm, .html, .json, .jsonl, .tsv, .txt, .xml, and other non-binary text files 
- can extract files and look at up to 1 million files and up to a depth of 10 levels
- video and pictures cannot be observed
### Integration with Organizations
- able to establish Macie Administrator account and run data discovery jobs across all accounts
    - can only have one Macie admin account
    - if Macie Admin account is changed, all other accounts are removed 
    - once an account becomes a member, it can not remove itself from membership 
- able to view all findings in all other accounts
- can have up to 5,000(!) members
- recommended to not be the same account as the organization root account 
### Costs
- number of S3 buckets evaluated
    - per bucket - $.10 per bucket/month
        - prorated per day
- quantity of data processed 
    - $1/gb/mo, and decreases as more data is processed

# Overview of Amazon CloudWatch
## What is Amazon CloudWatch?
- global service designed to be a window into health and operational performance of apps & infrastructure 
    - monitor & review performance
    - can trigger automatic responses 
- components 
    - CW Dashboards
        - build & customize page using different widgets 
        - resources can be from multiple regions 
        - can be shared w other users - even those not in the account 
    - CW Metrics + Anomaly Detection
        - metrics are key component and fundamental to the success of CW
            - enable tracking metrics over time 
            - different services offer different metrics
        - by default, everyone has access to a free set of metrics that are collated over 5 minutes
        - can collate data across the metrics every minute for a fee 
        - custom metrics are regional 
        - anomaly detection: CW implments ML against metric data to detect activity outside of the baseline
    - CW Alarms
        - tightly integrated w metrics 
        - allow automatic measures to occur based on metrics 
        - states
            - ok: metric w/n threshold
            - alarm: metric exceeded threshold
            - insufficient_data: waiting for info
        - can integrate w dashboards
    - CW EventBridge
        - extension of CW events 
        - connect applications to variety of targets (typically AWS services) to allow real-time responses to events
        - event: anything that causes change to env or app 
        - helps implement event-driven architecture in a real-time decoupled env 
        - elements
            - rules: filter for incoming stream of event traffic 
                - can route traffic to mulitple targets
            - targets: where events are sent by rules 
                - all events received in json
            - event bus: component that receives the event from apps 
                - rules associated with the bus 
                - default bus available, and other buses can be created
    - CW Logs
        - centralized location to store logs from AWS services that have log output 
        - acts as a central repository for real-time monitoring of log data 
        - requires unified cloudwatch agent that can collect from linux or windows - this is in addition to regular logging 
    - CW Insights  
        - can use to monitor log stream in real-time
        - types
            - log insights: analyze logs captured by CW logs at scale in seconds using interactive queries and delivers visualzations
                - can use to filter log data to get specific data 
            - container insights: collate and group metric data from container services + apps 
                - EKS, ECS
                - capture and monitor diagnostic data for add'l insights to issues w/n containers 
                     - can be analysed at cluster, node, pod, and task level 
            - lambda insights: gain deeper understanding of apps using lambda
                - gathers and aggregated metrics related to lambda to help monitor + troubleshoot serverless apps 
                - have to enable the feature per lambda function

# Building CloudWatch Dashboards 
- quickly display key information
- CW also has automatic dashboards on a service-by-service basis
- two ways to create dashboards: GUI or programatically
    - eight widget types
        - line chart
        - stacked area
        - number 
        - bar chart 
        - pie chart 
        - text: free text w markdown formatting
        - log tables: explore results from logs insights
        - alarm status 
    - able to apply math to data in dashboards 
    - json template of dashboards can be a bit challenging 
        - requires the location and data to be written 
- able to add annotation to graphs 
    - vertical and horizontal annotations can be added 
- can link w different dashboards in other regions and accounts
    - must enable cross-region or cross-account connections & other account must accept
    - sharing methods
        - share just one dashboard with a specific region or account 
        - share dashboard(s) publicly
        - connect all dashboards to SSO provider (like AD) to allow users from the SSO to be able to see the dashboards 
            - must be integrated with cognito
- cost
    - 3 dashboards w 50 widgets
    - $3/dashboard for larger than that 
- recommendations
    - make most important graphs the largest 
    - avoid plotting too much data in a graph
    - use horizontal annotations to show normal min and max values 

# How to Implement and Enable Logging Across AWS Services
## The Benefits of Logging
- without logging, there could be a delay in resolution fo the incident and the safeguarding of the env
- logs generally contain a huge amount of info retained on persistent storage
- audit control
    - often contain lots of metadata like date-stamps, source info (IP address, usernames)
- incident resolution
    - use logs to ascertain state of env before/after and during incident
- monitoring & alerting
    - monitoring allows quick identification of potential issues & get alerts 
- trend analysis
    - build a performance baseline to establish what's routine, and be able to identify threats & anomalies easier
- understanding infrastructure
    - understanding how infra is performing and communicating is key
    - having more data far outweights the disadvantages of not having enough 
## CloudWatch Logging Agent
- CloudWatch Logs
    - CW: used to collate and collect metrics on resources, monitor performance & respond to alerts
    - able to collect logs of apps & AWS services
    - able to monitor log streams in real-time
- unified CW agents
    - after installed, able to collect logs from EC2 instances & on-prem servers (in addition to std metrics)
- CW agent installation
    - create & attach role to instance so CW can collect data from instances & interact w ssm
        - need a role to install agent & to communicate w parameter store w/n ssm to store a config info file of agent
            - only one instance needs to be able to communicate w parameter store - best to remove this role after the config is written
            - cloudwatchagentadminpolicy & amazonec2roleforssm policies for the add'l perms for ssm
            - cloudwatchagentserverpolicy & amazonec2roleforssm policies to install agent and send data to CW 
    - download & install agent
        - on the instance w the admin policy (should only be temporarily attached)
            - download CW agent (instance needs access to agent)
            - agent may already be installed on certain AMIs
        - easiest to do it via SSM 
            - ssm > run command > run command > AWS-ConfigureAWSPackage
            - select instance to install on 
            - package: AmazonCloudWatchAgent
            - also able to do it from CLI (this page generates the command as well)
    - configure & start agent
        - on the first instance, must create CloudWatch Agent Configuration File
        - can be created or via the wizard 
            - wizard: `sudo /opt/aws/amazon-cloudwatch-agent/bi/amazon-cloudwatch-agent-config-wizard` 
                - one of the questions is 'do you want to store the config in the SSM parameter store', which then stores it in SSM and allows future read-only type instances be able to pull the config 
                    - may need credentials to upload to parameter store 
        - after the file is in SSM, go to SSM > run command > run command > `document name prefix: equal: AmazonCloudWatch-ManageAgent`
## CloudTrail Logging 
- AWS CloudTrail: records & tracks all AWS API requests made 
- captures request as an event and records this event w/n log file that's stored in S3 
- CT records add'l metadata like identity of caller, timestamp, source IP addr 
- log files
    - written in JSON
    - when API captured, associated w event & written to log
    - new logs created every 5 minutes
    - logs delivered to S3 buckets ~15 minutes after API called 
    - important attributes captured: eventName, eventSource, eventTime, SourceIPAddress (of requester who made API call), userAgent (method of request, console, root, lambda), userIdentity (add'l info on identity that made request)
    - naming format
        - AccountID_CloudTrail_RegionName_YYYMMDDTHHmmZ_UniqueSTring.FileNameFormat
            - random 16 character string used to CT as identifier
            - format json.gz by default 
    - s3 bucket folder structure
        - BucketName/prefix/AWSLogs/AccountID/CloudTrail/RegionName/YYYY/MM/DD
        - especially useful when multiple AWS accounts are delivering to the same bucket 
            - to aggregate logs, enable CT in AWS account, apply perms to destination S# bucket allowing cross-account access
            - create new CT & use bucket from another account 
            - to allow access to users to read the logs relating to their CT logs, have them use read-only roles to view only the logs from their account CT 
- CT log files security
    - log file integrity validation
        - allows verification that log files have remained unchanged since CT delivered them to S3 
            - typically for security & forensic investigation
        - when log file delivered to S3, CT creates a hash for it 
            - in addition to creating the hashes, CT creates a digest file every hour to help verify log files 
            - verification of log files can only be done via CLI 
## Monitoring CloudTrail with CloudWatch
- CT can send logs to CW logs, which allows metrics & thresholds to be configured
    - any event can be monitored; successful & unsuccessful API calls can be tracked 
- configure CT to use CW
    - make new CT use a new or existing CW log group
    - need a role & policy to allow CT to deliver to CW
        - CT needs to be able to CreateLogStream, PutLogEvents, then can deliver to CW logs 
        - role CloudTrail_CloudWatchLogs_role automatically made for CT to be used
        - CW logs can only accept items up to 256KB in size - larger than that won't be delivered 
    - CW must be config'd to perform searches on CT logs 
## S3 Access Logs
- collate data based on who has been accessing an s3 bucket
    - tracks the following metrics 
        - source bucket that was accessed
        - timestamp of events
        - identity requesting access to object in bucket
        - action performed w object 
- by default, access logging not enabled
- configuration based on source bucket & target bucket
    - source bucket: bucket to log requests for
    - target bucket: bucket to write logs to
    - recommended the buckets are different
    - buckets must be in the same region
    - needs write access for log delivery group
        - in the console, automatically created 
## CloudFront Access Logs
- CloudFront: speeds up distribution of static and dynamic content
    - requests routed to the edge location w lowest latency
    - can record the requests to S3
        - charged for storage on S3
- CF Access Logs
    - capture data over period of time + amount of log files generated depend on amount of requests recived
    - logs not written to S3, simply stored there
- enable: CF > general > logging: on
- CF needs permissions to S3 to write
    - needs FULL_CONTROL of the ACL, s3:GetBucketAcl, s3:PutBucketAcl
- Log files
    - depending on delivery type, the log output will vary
    - RTMP is depreciated
        - data/timestamp + which edge location received request
        - source metadata including ip 
        - event being carried out (Play, Pause, Stop)
        - URL of page where SWF file is linked 
    - web delivery info
        - data/timestamp + which edge location received request
        - source metadata including ip 
        - HTTP access method (PUT/DELETE/GET/etc)
        - HTTP status code of request
        - distribution domain name
        - encryption & protocol data 
- cookie logging
    - if enabled w/n distribution, CF will include all cookie info w CF access log data 
    - only if origin on distrubtion points to anything OTHER than S3, like EC2 (s3 does not process cookie data)
## VPC Flow Logs
- vpc flow logs capture IP traffic info that flows w/n VPC
- helps to resolve incidents w network communication & traffic flow
- log data is sent to CW logs 
- limitations
    - w VPC peered connections, can only see logs of peered VPCs w/n same account 
    - can't retrieve info from resources w/n EC2-classic env
    - once flow log has been created, it can't be changed 
    - traffic not monitored
        - DHCP traffic w/n VPC
        - traffic from instances destined for Amazon DNS servers
        - traffic destined to the IP addresses for VPC default router
        - traffic to and from 169.254.169.254 (metadata), 169.254.169.123 (time sync service)
        - traffic related to Amazon Windows activation license from a windows instance
        - traffic b/w NLB ENI + endpoint network interface 
- VPC Flow logs
    - can be created against three resources
        - ENI on instance
        - subnet w/n VPC
            - data captured for all network interfaces
        - VPC
            - data captured for all network interfaces
- publishing data to CW
    - every ENI that publishes data to CW log group uses a different log stream
    - w/n each stream there is flow log event data that shows content of log entries 
    - each log captures data during windows of ~10-15 minutes
- permissions
    - role needed to setup and config VPC flow log
    - VPC flow log needs to assume role to deliver logs to CW 
- flow log record
    - version  account-id  interface-id  srcaddr  dstaddr srcport dstport protocol  packets  bytes  start end  action log-status 
## AWS Config Logging
- what can AWS config do
    - capture resource changes 
    - act as resource inventory
    - store configuration history
        - uses configuration items (CIs) to collate and produce a history of changes to a particular resource
        - info can be accessed thru CLI or console 
        - sends a config history file for each resource type to S3 every 6 hours that contains all CI changes for resources
        - CI stores config info, relationship info + other metadata in a json file
            - CI created every time supported resource has change made to config
            - for every CI generated, there will be five sections
                - Metadata: version and config ID, MD5Hash for comparision, time of capture and state ID
                - Attributes: unique resource ID, key-value tags, resource type, ARN
                - Relationships: description of relationships to other resources
                    - e.g., for ec2: vpc it resides in, etc
                - Current Configuration: displays info from 'Describe' or 'List' calls from CLI
                - Related Events: displays related AWS CT event ID 
            - can aggregated configuration history files into same s3 bucket
    - provide a snapshot of resource configurations 
    - notifications about changes 
    - provide AWS CT integration 
    - enforce rules to check compliancy 
    - security analysis
    - identity relationships between resources 
## Filtering & Querying data with Amazon Athena 
- can use Amazon Athena to query data w SQL w/n S3 to search for specific entries 
- must create DB, either with SQL, or in Catalog Manager with a wizard, and a S3 bucket to store the Athena DB (not for querying yet)
    - works like regular DB, and tables and such can be created and point to a S3 bucket to query from
- basically everything done with SQL
- queries can be saved with a name and description 
- can view past executed queries in history - both the command & results of the command  

# KMS 
## What is Encryption
- unencrypted data: aka plaintext/cleartext
- data encryption: mechanism in which info is altered, rendering the plain text data unreadable 
    - plaintext turned into cyphertext 
    - need an encryption key to covert back to plaintext
    - longer the key, more difficult it is
- symmetric cryptography: single key used to encrypted & decrypted 
    - the problem is if a third party gets the key, since the key has to be shared 
    - KMS can function as a central repository for storing this key for additional security 
    - faster than asymmetric encryption
- asymmetric encryption
    - encryption key (private key)
    - decryption key (public key)
        - able to be shared - doesn't need to be sent securely
        - w/o private key, unable to open it 
## An Overview of AWS KMS
- KMS: managed service used to store and generate encryption keys 
    - other services able to use KMS for encryption 
- AWS has no access to custom keys & cannot recover deleted keys
    - only responsible for the hardware hosting the service 
- core components 
    - AWS KMS keys: encrypt and decrypt data
    - customer managed keys: created, managed and controlled by customer
    - AWS managed keys: managed by integrated AWS services
    - AWS owned keys: managed by AWS, used across multiple accounts; not tied to individual account
    - data keys: encrypt data outside of KMS
    - HMAC keys: symmatric key to create & verify HMAC codes 
    - only able to encrypt data at rest with these keys 
        - data in transit needs method like SSL
        - data encrypted at rest would remain encrypted when sent to others 
## Components of the KMS service 
- AWS KMS keys
    - primary keys w/n KMS that can be used to perform crypto ops
    - key can be used to generate data keys
    - when generated, created as symmetric 256-bit AES-GCM encryption key
    - will live in KMS permanently
    - by default, AWS services use symmetric encryption
- assymetric keys used when encryption needed outside of KMS
- key types
    - customer managed keys (CMKs)
        - asymmetric keys
        - provide greater key control
        - create key policies 
        - admin functions available: enable/disable, manage rotation, add tags, create aliases, manage deletion
    - AWS managed keys
        - automatically generated
        - integrate w KMS
        - perform same function as CMKs
        - can be viewed w/n KMS
        - easily identifiable: aws/servicename is the standard naming
        - users cannot manage key in any way
    - HMAC keys
        - Hash-based Authentication Code
            - take message data + HMAC key that's associated w metadata of object to check integrity & authenticity of data 
        - confirms to standards sset by RDS 2104
    - Data keys
        - generated by KMS
        - meant to be used outside of KMS
        - uses symmetric encryption; it uses a plaintext and encrypted version of the same key 
    - Data key pairs
        - use asymmetric encryption
        - supported type 
            - RSA, elliptic curve, HM
        - private key store in KMS & encrypted by KMS key
        - plaintext private key + encrypted version created
        - encryption: public key + algorithm = cyphertext
        - decryption: data keys + plaintext keys + algorithm = plaintext 
    - Key Material
        - element used as part of crypto algorithm
        - private key material
            - must be protected
            - symmetric encryption required
        - public key material
            - asyemmetric encryption
            - public key 
        - key material storage for symmetric keys 
            - AWS KMS
            - external key manager
            - CloudHSM
    - key rotation
        - should be implemented for CMKs
        - can be done automatically & managed by AWS 
            - key doesn't change; key material associated with key changes 
        - for AWS managed/owned keys, AWS does automatically 
        - all previous key information is saved in rotation - data encrypted before the rotation is still accessable, and uses the cryptographic information of the key from when it was originally encrypted 
    - key policy
        - security feature w/n KMS that allows defining who can use and access particular keys 
        - resource-based policies
        - different policies can be created for different KMS keys
        - permissions defined w/n JSON key policy document 
    - grants
        - temporary-based policy
        - resource-based policy
        - allow delegation of subset of user's access to KMS key for another principal, such as another user w/n AWS account 
        - less risk of someone altering access control perm's for the KMS key
        - grant created & applied to KMS key for each principle requiring access 
## AWS KMS Permissions and Key Policies 
- to use IAM policies, have to allow the use of IAM policies w/n KMS key policy
    - enabling the use of IAM doesn't provide access, just allows policies in IAM to govern user access to the key 
    - access given to root, with the upside of always being able to have access to key at some level 
- KMS key policies
    - resource based
    - contain info like
        - IAM user permissions
        - who can administer key
            - can only perform administrative actions with the key, not cryptographic actions (although they can do both if the permissions are set up correctly)
            - can specify if they can delete key
            - have ability to update key policy and allow themselves to use the key
        - cryptographic operations
        - grants 
    - JSON based and largely similar to IAM policies in format 
    - allow use of key to key users
    - grants: allow attachment of persistent resources
        - the way to allow users to provide grants 
        - grants must be made via KMS APIs; not possible in the console  
        - only have access to single KMS keys
        - can only be granted to single users
        - can only have 'allow' permissions, not deny
        - permissions may take some time to propogate; tokens are eventual consistency
        - retire: use when grant is no longer needed
        - revoke: use if key becomes compromised
        - grants do not expire; valid until retired or revoked  
- KMS events will not appear in event history 
## KMS Access: Policy Evaluation Logic 
- policy types 
    - key policy
    - IAM policies
    - grants
- least privileged access: any deny has overarching importance, and user needs explicit access 
## Sharing CMKs Across Multiple AWS Accounts 
- Custom master key
    - can create data encryption keys for external data encryption 
    - managed by AWS: used by AWS services (S3, SSE-KMS)
    - managed by customer: 
        - greater flexibility
        - manage the key 
            - rotation
            - governing access
            - key policy configuration
            - enable and disable key
- access control
    - identity-based IAM policies
    - resource-based access 
    - to manage access to CMKs, key policy must be used 
    - must use resource-based key policy where the CMK resides along w IAM identity-based policy in AWS acct that wants to access the CMK
    - can only edit key policies for keys that you have created 
        - can't share managed CMKs b/w accounts 
- key policies
    - resource-based policies tied to CMK
    - KMS creates a default key policy when the key is created in the console 
    - define permissions for
        - key administrators: administer CMK, but don't use for encryption
        - users: can access CMK + perform encryption
    - to allow another account, add IAM users from the other account in the policy JSON
        - users w/n the external account need IAM users/roles in their account to be set & associated to be able to use the CMK 
        - need the ARN of the key to add to the policy in the other acct 
        - once connected, key won't show in console (e.g. in KMS option in S3); will have to use ARN to use it 

# Sharing Secrets Between Multiple Accounts Using AWS Secrets Manager
- secrets manager  
    - secret: password, API keys, plaintext; something to remain hidden from world
    - able to remove hardcoded secrets w/n app and replace w API call to secrets manager 
    - enables easier secrets rotation
    - integrates closely w AWS services 
- access to secrets
    - goverened by fine-grained IAM identity-based policies + resource-based policies 
- sharing secrets b/w accounts
    - with the goal of having a single account with all secrets stored centrally 
    - account with secrets, key policy needs to allow user/role from other account to use the key 
        - have to set a resource-based policy on the secret, but can only do it via a JSON document applied via CLI 
    - account using the secret, role/user needs policy allowing reading of the secret and decryption of KMS to be able to actually use the secret

# CloudHSM
## What is CloudHSM
- HSM: hardware security module
    - physical, tamper-resistant hardware appliance used to protect and safeguard cryptographic material and encryption keys
- provides Federal Information Processing Standards (FIPS) 140-2 level 3 (used for document signing, CAs)
- physical single-tenant device
- used for secure encryption key management 
- create, store, manage cryptographic keys
- ability to use cryptgraphic hash functions (HMACs)
    - symmetric & asymmetric
- able to manage HSMs to a greater degree than KMS HSMs
## Understanding AWS CloudHSM Architecture & Implementation
- begin by creating a cluster over multiple AZs for HA
- any requests to cluster load balanced b/w HSMs in cluster 
- ENI placed in customer-owned VPC, and connects to an AWS-owned CloudHSM-owned VPC
- creates a service-linked role and SG for the cluster w ports 2223-2225
- provisioned in uninitialized state 
- once initialized, able to connect via EC2s w/n subnets/vpcs
- add instance to cluster SG
    - must enable 22/3389
- install AWS CloudHSM client software on instance 
## Access Control
- users on HSM devices + need IAM permissions
- types of users on HSM
    - precrypto office (PRECO)
        - first HSM connected to has this user which is a temporary user with temp credentials of read-only access to cluster
        - part of activation process of cluster PRECO PW will be changed, and becomes CO 
    - crypto office (CO)
        - can perform user management tasks
            - creation & deletion of users
            - changing users passwords
        - perform administrative level cryptographic operations 
            - zeroize data on HSM
            - obtain HSM details (IP addresses, models, serial numbers)
            - view & determine syncrhonization status across cluster 
    - crypto user (CU)
        - used to perform cryptographic operations and key management functions in cluster
            - create, delete, import/export + share of crypto keys
            - perform encryption & decryption
            - signing & verifying 
        - also able to zeroize data & get HSM details & sync status 
    - appliance user (AU)
        - performs cloning and sync across cluster
- HSMs designed w physical tamper detection + response processes 
    - performs key deletion if compromise detected
    - resistant against brute force attacks + will lock user out if identified 
## Using CloudHSM as a Custom Key Store in KMS
- KMS: can create custom key store, which are storage locations to store and protect crypto key
    - default key stores managed by KMS & stored on HSMs managed by AWS
    - can create a custom key store and have full management over CloudHSM store
    - benefit: wide integration w other AWS services w minimal configuration 
- custom key store obtains key material from CloudHSM cluster, and able to leverage the power of KMS 
- each HSM cluster can only be associated w one custom key store
    - must upload trust anchor certificate for cluster to KMS to create custom key store 
- a user must be created for KMS for it to access crypto information on HSM cluster 
## Monitoring & Logging 
- pushes metric data to CW 
    - HsmUnhealthy
    - HsmTemperature
        - machine will shut down if temp gets to 110C
    - HsmKeysSessionOccupied
    - HsmKeysTokenOccupied
    - HsmSslCtxsOccupied
    - HsmSessionCount
    - HsmUsersAvailable
    - HsmUsersMax
    - InterfaceEth2OctetsInput
    - InterfaceEth2OctetsOutput
- CT can track and record API calls for CloudHSM
- CW logs can track audit logs 
    - generated by CloudHSM clients using the CloudHSM client daemon
    - retrieved by viewing file on client or by entering a command 
    - can't be disabled or turned off, either locally or on the way to CW logs 
    - allows full audit of all actions and requests that have made changes to HSM

# AWS Encryption for Data Analytics
## Amazon S3 and Amazon Aethna Encryption
- S3 encryption options
    - SSE
        - used for securing data at rest
        - data encrypted at object level before written to disk
        - forms
            - SSE-S3 (amazon s3 managed keys)
                - Amazon S3 uses unique key to encrypt each data object & the key is encrypted w Master Key 
                - objects encrypted w AES-256 (which is symmetric), which is fine, since AWS manages encryption & decryption 
                - works w S3 bucket policies (e.g., enforce SSE w conditions in policy)
            - SSE-KMS (keys managed by AWS via KMS)
                - have the option to select default AWS S3 CMK or choose a customer managed CMK
                - KMS CMK is used to encrypt the data keys, not the actual object data itself 
                - when uploading an object: request made from S3 to KMS, KMS returns two versions of data key, one in plaintext, and is used by S3 to encrypt object. The other key is encrypted and uploaded w the object 
                - decryption: S3 sends encrypted data key to KMS, KMS uses CMK associated to decrypt the data key, and KMS responds w plaintext key 
                    - plaintext key stored in memory and deleted after actions are copmleted 
            - SSE-C (keys managed by customer & provided to AWS)
                - customer must supply key and S3 service performs the encryption
                - must send customer-provided key w data object upload request using HTTPS
                - after encryption, AWS deletes the AES-256 key from memory and stores HMAC value
                - must use the same key to decrypt
    - CSE (client side encryption)
        - data encyprted before being sent to S3
        - CSE-KMS (CSE using KMS)
            - only need to supply CMK-ID to the S3 encryption client
            - when object uploaded, request is made by the client and KMS returns a plaintext and ciphered visions of a data key
            - when object retrieved, client sends the ciphered key to KMS to retrieve the matching plaintext version
        - CSE-C (client-side encryption using a custom client-side master key)
            - key is never sent to AWS
            - when uploading an object, master key must be provided to client 
            - master key will be used to encrypt a data key generated by the client, which will be used to encrypt the object data 
            - when object retrieved, the master key is used to decrypt the data key & object is decrypted 
- Encryption with Amazon Athena 
    - able to query S3 data that is already encrypted
    - it can encrypted the results of the query
    - the encryption of results is independent of the underlying queried S3 data 
        - i.e. can encrypt results of unencrypted data 
    - supports SSE-S3, SSE-KMS, CSE-KMS
    - doesn't support SSE-C, CSE-C
    - can only unencrypt objects that are in the same region 
## Elastic MapReduce (EMR) Encryption
- EMR: managed service comprised of a cluster of highly scalable EC@ instances to process and run big data frameworks
- can encrypt data at rest, in transit or both
    - the exist as a separate entity w/n EMR & can apply to future created clusters
- by default, instances w/n cluster don't encrypt data at rest
- BY DEFAULT, DOESN'T ENABLE ENCRYPTION AT REST 
- instances w/n EMR are created from pre-config'd AMIs
- must use EMR 5.7.0 to use custom AMIs and encrypt the root device volume 
- EMR encryption w EBS
    - if using EBS as persistent storage (not applicable to root volumes)
        - Linux Unified Key Setup (LUKS): specify KMS to be used as key management provider or use custom key provider
        - Open-Source HDFS Encryption: secure Hadoop RPC, uses SASL
            - data encryption of HDFS block transfer uses AES-256
- EMR encryption with S3
    - can use S3's encryption tools
    - supports SSE-S3/SSE-KMS or CSE-KMS and CSE-C (if data is encrypted before being sent)
    - encryption in transit using TLS cert provider
        - must provide pem to S3
- EMR application specific encryption
    - Hadoop
        - Hadoop MapReduce Encrypted Shuffle uses TLS
        - secure Hadoop RPC uses SASL (simple authentication security layer)
        - data encryption of HDFS block transfer uses AES-256
    - presto
        - when using EMR 5.6.0+ any internal comms b/w presto ndoes use SSL/TLS
    - tez
        - tez shuffle handler uses TLS
    - spark 
        - Akka protocol uses TLS
        - block transfer service uses SASL and 3DES
        - external shuffle service uses SASL
- EMR encryption w KMS
    - when using encryption at rest using KMS CMKs
        - ensure that role assigned to instance w/n cluster have relevant permissions to enable access to CMK
        - add relevant role to key users for CMK
- EMR transparent encryption w HDFS
    - offers encryption both at rest and in transit
    - data encrypted and decrtyped transparentingly w/o requiring changes to app code
    - each HDFS encryption zone has own KMS key; by default EMR uses Hadoop KMS, but alternative can be selected 
    - each file is encrypted by a different data key, which are encrypted w HDFS encryption zone key; not possible to move files b/w encryption zones 
## RDS Encryption
- during creation of RDS, encryption can be enabled at Configure Advanced Settings screen 
    - keys can be issued by KMS using AES-256
    - encryption can't be applied after DB creation
- to encrypt an unencrypted DB, 
    - create snapshot of unecnrypted DB
    - create encrypted copy of the snapshot
    - use the encrypted snapshot to create new DB
    - now have an encrypted RDS DB 
- RDS encryption
    - if KMS ke3y is disabled, will not be able to read or write to DB and RDS will move its instances to terminal state
    - must reinstate the KMS key and recovery DB from backup
    - read replicas follow same encryption pattern as defined by the DB source 
- RDS encryption mechanisms
    - Oracle and SQL Server Transparent Data Encryption (TDE)
        - can be used in addition to KMS, but would impact performance of DB 
        - to use, DB must be associated to an option group
            - option groups provide default settings for DB & help w management
            - option groups only exist for oracle, mariadb, mySQL, and some versions of MSSQL server 
        - must add Oracle Transparent Data Encryption option to the group, and it can't be removed 
        - TDE Encryption modes
            - TDE tablespace encryption: encrypts entire table
            - TDS column encryption: encrypts single columns 
    - MySQL cryptographic functions 
    - Microsoft Transact-SQL cryptographic functions 
- RDS Encryption: Instance Types 
    - offers ability to encrypt instances across all regions other than China (Beijing) region, and across ~20 types of instances
    - applying encryption at rest for RDS simplified due to built-in app-level encryption option 
- encryption in transit
    - can be secured using SSL/TLS
    - recommended if required to abide by specific compliance or when data is sensitive
    - method how this works based on DB engine type
- RDS encryption w Oracle
    - can use Oracle's Native Network Encryption (NNE)
    - will encrypt all connections w DB
    - not possible to use SSL and NNE together 
    - to enable, add NATIVE_NETWORK_ENCRYPTION to DB options group 
## Amazon Kinesis Encryption
- Amazon Kinesis Firehose
    - delivers real-time streaming data to different service w/n AWS; can be useful for big data
    - fully managed by AWS 
    - receives data from data producer and delivers to destination
    - encryption
        - can be sent via HTTPS; when enters Kinesis, is unencrypted by default 
        - can implement encryption using SSE-KMS on S3
            - relevant perms must be assigned to a role for access 
    - even when sending data to redshift/ElasticSearch, data is stored in S3 and has the applicable encryption there
- Amazon Kinesis Streams
    - collects and processes huge amount of data in real-time
    - data can come from varity of sources 
    - encryption
        - able to implment SSE-KMS directly from producers
            - gives full at-rest encryption 
            - new data key generated every 5 minutes 
            - small latency of less than 100 micro seconds added to performance 
        - both producer and consume apps need perms to use KMS key
            - producer: something that adds data to Kinesis stream
            - consume: Kinesis app that processes data from stream 
## Amazon Redshift 
- redshift: managed service for data warehousing for big data solution
    - able to scale up to 1 PB
- Redshift Encryption   
    - offers encryption at rest using 4-tiered hierarchy using either KMS or CloudHSM
        - T1: the master key
            - managed by KMS or CloudHSM
            - integration w HSM device req's add'l steps to implement
        - T2: cluster encryption key (CEK)
        - T3: db encryption key (DEK)
        - T4: data encryption keys 
    - when encryption is enabled it can't be disabled and vice cersa
        - can only turn on encryption at creation
    - once cluster is encrypted, data, metadata and snapshots are also encrypted 
- KMS encryption for redshift
    - either use default KMS key or select another CMK
    - default key automatically made when encryption is chosen upon creation 
    - CMK known as master key on tier 1
        - redshift will send request to KMS for new KMS data key
        - KMS data key encrypted w CMK master key
        - encrypted KMS data key then used as the Cluster Encryption Key (CEK)
        - CEK sent to redshift and stored separately from cluster
        - redshift sends CEK to cluster over asecure channel & key stored in memory
        - redshift requests KMS decrypts T2 CEK
        - decrypted CEK also stored in memory
        - redshift creates random DEK and loads it into memory
        - decrypted CEK in memory encrypts the DEK which is also stored in memory
        - encrypted DEK is stored separately from the cluster
        - encrypted and decrypted CEK & DEK are stored in memory
        - decrtyped DEK encrypts the data keys generated by redshift 
- CloudHSM encryption for Redshift 
    - to work wth CloudHSM, must set up trusted connection b/w both HSM client and redshift using client and server certs 
    - using a key pair, redshift creates public client cert 
    - cert is downloaded and registered to HSM client & assigned to correct HSM partition
    - must config redshift w HSM ip addr, partition name/password, public HSM server cert
    - after info provided, redshift confirms it's able to use the connection 
- key rotation
    - redshift enables rotation of encryption keys for encrypted clusters
    - be aware: cluster will be unavailable for a short period of time during the key rotation process
    - during rotation
        - redshift will rotate CEK & CEK for backups
        - rotate DEK
        - put cluster into state of ROTATING_KEYS until process complete
    - perform key rotation w console
        - redshift > clusters > pick cluster > select db > rotate encryption keys > yes, rotate keys 

# Protecting Web Apps with AWS WAF, Shield, & Firewall Manager
## WAF
### What is WAF & what does it do? 
WAF: helps prevent web sites and web apps from being maliciously attacked by common web attack
patterns
1652
used to identify how Cloudfront distrubutions and ALBs respond to web requests
1653
filters HTTP and HTTPS requests distinguishing between legit and malicious users
1654
- WAF components
    - conditions
        - specify what elements of incoming HTTP(S) request to monitor for
            - cross-site scripting: scripts written to maliciously gain access to client-side data from another user via a web apo
                - scripts embedded w/n web pages that are normally trusted
                - can be data like cookies
            - geo match
                - specify which countries and geographic functions for WAF to filter on
                - if using geo restriction w/n CF to block country, then traffic from that country won't make it to WAF ip addresses
            - ip addresses 
                - specify a single IP addr or a range of IP addrs to allow or block
                - can be used in conjunction w geo match
            - size constraints
                - block traffic based on size of parts of requests. can define which part to look for
            - SOL injection attacks
                - can alter and read data w/n db and spoof identities
                - performed by inserting a SQL query via client into an entry field to a remote app db
            - string and regex matching
                - identify web requests based on strings contained w/n request itself
                - when creating a web ACL, can allow or block
    - rules
        - allows compliation of one or more conditions into a list, where each condition is ANDed to form the complete rule
        - requests must meet all the rules to help with more specific matching
        - types
            - regular
            - rate-based
                - count number of requests from a single IP over 5 minutes
                - When limit is reached, further requests are blocked 
                - if traffic drops below limit, requests are unblocked
                - must be >=2,000 requests, otherwise is just a regular rule adding conditions to rules
                every condition in rule has to be met for the action of the rule to be carried out
    - web ACLs
        - rules are added here
            - final decision if traffic is allowed or block
            - action applied for each rule: Allow, Block, Count
                - allow: request forwarded to CF distribution or ALB
                - block: request terminated
                - count: count number of requests that meet conditions w/n rule
                    - helpful in testing to see how much traffic meets this rule before making it allow/ block
            - rules executed in the order that they are listed w/n web ACL
                - usually listed whitelisted (allow), blacklisted (block), bad signatures (block)
### When and why should I use WAF?
- if delivering web content via CFt or ALB, recommended to implement WAF as an add'l layer of security 
- benefits
    - huge asset to web app arch
    - quicker and simpler to manage than standard WAF solutions
        - easy to manage via console or cli/apis
        - integrates w CW for monitoring and Lambda for automation
    - might help achieve higher level of security compliance 
    - the closer the detection systems are logically implemented to web app, the greater the risk of add'l vulnerabilities being exploited 
    - logically, sits b/w end user & CFt distributions
        - however, request will be received by CFt distribution first and then forwarded to associatd WAF web ACL
### WAF Demo
- cloudwatch metrics made for ACL and for rules 
- to attach to CFt, go to CFt console & go to general > edit to add WAF ACL
### Monitoring WAF
- in AWS WAF dashboard, able to view statistical info for web ACLs created 
    - can't generate reports here 
- integrating w CW
    - metrics reported in one minute intervals & kept for 2 week periods
    - sum count of
        - AllowedRequests
        - BlockedRequests
        - CountedRequests
        - PassedRequests
    - for each ACL, there will be an associated CW metric 
### Limitations of WAF
- 100 conditions of each type, except regex, which allows only 10 conditions (soft limit)
- 100 rules and 50 web ACLs per acct
- 5 rate-based-rules per acct 
- 10,000 requests per second for WAF w ALB 
- same web ACL can be assigned to different CFt distributions 
### WAF and CloudFront
- WAF relies heavily on CFt distributions
    - CFt does not rely on WAF
- WAF supports custom origins, allowing applying the same level of security to web infra managed outside of AWs
- associate b/w web ACL and CFt distrubtion can take ~15 min for Web ACL and rules to be propigated 
- when request blocked by WAF, CFt notified request was forbidden & returns 403 to browser
    - error doesn't provide any useful info to user 
        - can create custom 403 errors to guide users to issues for access 
- use combo of CFt config and WAF Web ACLs to process incoming requests leveraging settings from both services 
    - e.g. if CFt will not respond to certain methods, no need to also block those in WAF
### WAF Pricing
- number of incoming requests
    - $0.60 per million requests
- number of Web ACLs
    - not chargee xtra for assigning the same Web ACL to multiple distributions 
    - $5 per Web ACL per mo
- number of rules w/n each of Web ACL
    - $1 per rule per Web ACL per month 
- all charges in addition to using CFt
- no upfront costs, and not very expensive overall 
## AWS Firewall Manager
### Overview of Firewall Manager
- simplify managing WAF in multi-account env w simplicity and control
- able to protect all vulnerable resources across all of AWS accts w/n AWS organization
- prerequesites
    - AWS account must be parent of AWS organization, which must have been config'd w all features 
    - define which AWS acct will act as the firewall manager admin
    - AWS config must be enabled 
### Components of Firewall Manager
- WAF rules (same as rules in the actual WAF console)
- Rule Groups
    - allow group together one or more WAF rules that will have the same action applied
    - can create own group & add own WAF rules, or purchase existing rule groups via AWS marketplace 
    - can only contain block or count acionts (no allow action)
    - hard max of 10 rules per rule group 
- firewall manager policies 
    - after rule groups are created, this contains the rule groups 
    - hard limit of two rule groups: one custom, one from AWS marketplace  
    - $100 per policy per region per month 
## AWS Shield
### What is AWS Shield
- protect infrastructure against DDoS
- DDoS attacks
    - SYN flood
        - spoofed SYN packets sent to host, which sends SYN/ACK, but never receives ACK & leaves those requests open
    - DNS query flood
    - HTTP flood/cache-busting
        - send lots of requests to host, force content to be retrieved from originating server and not edge location 
- AWS Shield Standard
    - free: offers DDoS protection against common layer 3 & 4 attacks for S3 and CFt
- AWS Shield Advanced
    - offers protection to web apps running on EC2, CFt, ELB, route53
    - enhanced levels of DDoS protection offered compared to standard
    - access to 24/7 specalized DDoS respond team  
    - can view real-time metrics of any attacks against resources
    - protection against layer 3, 4, 7 attacks
    - cost protection as a part of the plan, and WAF is included in 
    - $3,000/mo 
    - account-specific
### Configuring Shield
- have to configure rate-based rules from WAF to help indicate DDoS attack is in progress 
    - only needed for ALBs and CFt
- pre-authorize AWS DDoS Response Team (DRT)
    - can allow DRT team access to resources to help in event of attack
    - must be subscribed to business or enterprise support 
    - team is given access by adding a role that they can assume 
- recommended to use CW + SNS + shield for notifications 
- global threat enviroment dashboard
    - shows number of attacks across AWS landscape 

# AWS VPC: Subnets and Routing
## VPC Subnets
### VPC CIDR Blocks
- subnetting: process of splitting CIDR block into smaller CIDR blocks 
- VPC creation requires IPv4 CIDR block
    - max block: /16 (65,531 hosts)
    - min block: /28 (11 hosts)
    - first available host address for VPC router
    - second available for AWS DNS
    - third available for future AWS use
    - remainder of addresses for host use
### Why Subnet your VPC? 
- logical network division
    - able to have SN for DB/app/web
- security
    - w logical division, allows for greater security mgmt 
- accessibility
    - split b/w private & public SN and have different controls for each 
- communication
- high availability
    - better to deploy resources across multiple subnets 
### VPC Subnets
- console info for subnets 
    - summary: provides summary of all metadata associated w subnet 
        - includes IPv4/6 CIDR, state, vpc, available IPs, az, route table, nacl, default SN (from default VPC) yes/no, auto-assign public ipv4/6 status
    - route table 
    - NACL: displays inbound & outbound rule sets 
    - flow logs
    - tags
### Public & Private Subnets
- public subnets have direct access to internet
    - IGW attached to VPC + added to SN default route 
    - instances w/n public SN will need public IP addr to communicate on internet
    - NACLs need to allow traffic in/out 
- ip addressing behavior
    - public ip addresses can be automatically or manually assigned to instance
    - by default, all subnets have automatic assignment disabled 
        - able to disable on instance if SN setting is automatic assignment 
    - must use EIP if the same IP addr is desired every time 
- private subnets have no direct access to the internet
### VPC Peering: Subnet Considerations
- allows connect two or more VPCs together as if they were part of the same network
- once established, resources in one can access resources in the other
- subnet considerations
    - vpcs w overlapping or duplicate CIDR blocks can't be peered
- it is not possible to create end-to-end communication of VPCs by daisy chaing them together
    - each VPC will only communicate w its peer 
### Flow Logs: VPC Subnets
- track traffic flow & troubleshoot network problems b/w VPCs, subnets, individual networking adapters 
## VPC Routing
### Routing Fundamentals & Route Tables
- routing: provides mechanism to allow network packets to be forwarded to the correct destination
- routing fundamentals
    - AWS creates & adds implicit router for VPC during CPV creation process
    - default route table, named 'Main Route Table' also created
    - main route table cannot be deleted & is implicitly associated w subnets 
        - able to set a new main route table; doesn't have to be the default one
    - subnets can be implicitly or explicitly associated w route table 
    - a subnet can only be associate w a single route table
    - a route table can be associated w multiple subnets 
- console info
    - summary: route table ID, explicit association, main yes/no, vpc 
    - routes: shows routing decisions made w/n routing table
        - destination: CIDR block for network to route to
        - target: gateway to route to
        - status
        - propogated yes/no
    - subnet associations 
        - can't use route table of another SN via daisy chaining 
        - under main route table, will show implicit and explicit associations
    - route propagation 
        - enable route propagation against virtual private gateway (VGW) attached to VPC
    - tags 
### Routing Priorities 
- longest prefix match: AWS will use most precise route available w/n route table to route traffic to specific destination
    - e.g., if there's routes for 192.168.0.0/16 and 192.168.1.0/24, will go to the /24 one 
    - exclusions
        - if route propagation is enabled for VGW & those propagated routes overlap the 'local' route - the local route will have precedence, even if propagated routes have LPM
        - if any propagated routes have the same destination as any static routes, LPM rule not aplpied. Route priority is executed against static routes in the following order
            - IGW > VGW > ENI > Instance ID > VPC peering connection > NAT gateway
                - read as, IGW has greater preferance than VGW, etc 
- route table limitations
    - soft limit of 200 routes per VPC
    - soft limit of 50 non-propagated routes (hard limit of 100)
    - each limit applies separately to IPv4 and IPv6
    - hard limit of 100 propagated routes per table 
### Routing: VPC Peering
- peering connections abbreviated w pcx
- subnets in both VPCs must include a route to subnets in the peered VPC using the pcx 
- CIDR block must not overlap for peered VPCs
- can peer to two separate VPCs that themselves have overlapping CIDR blocks
    - it's possible, but do try to avoid it... 
        - e.g. A connects to B, which is connected to A and C, and C is connected to B. 
            A and C both have the same CIDR range, and B has a separate one. Routing properly between A and C gets tricky when considering routing priorities 
    - peering does not support unicast reverse path forwarding 
        - i.e. if A and and C both have same CIDR range, and request comes from A, and they both have the same entry on the route table, the response would probably be routed to C
### Routing: VPN Connection via a Virtual Private Gateway
- required to set VPN connection between corporate network & VPC
- once VPG is attached, route tables for SN need to be updated to point to corporate network
- IPv6 not supported over VPG connection 
### Routing: Internet Gateways & NAT Gateways
- internet gateways     
    - public subnets must be able to route to IGW attached to VPC
    - IGW is means of communicating to internet fro mVPC 
    - IGWs are managed service
    - destination of 0.0.0.0/0 implies that any routes with unknown routes are sent to the internet 
- NAT gateways
    - allow instance w/n private subnet to initate a connection to the internet
    - access from internet cannot be initiated w instances w/n subnet behind NAT gateway
    - created per AZ, recommended to have multiple for HA 
### Routing: VPC Endpoints 
- virtual device which allow connection of VPC to other AWS services w/o using gateway
    - traffic remains w/n AWS global network
- S3 and DynamoDB supported
- doesn't impose risks of availability or bandwidth across VPC
- creating new endpoint automatically adds an entry to main route table 

# AWS Security Best Practices: Abstract & Container Services 
## Abstract & Container Services
- container service characteristics
    - run on separate infrastructure instances, such as ec2
    - AWS responsible for OS + platform 
    - managed services provided by AWS for the actual app which are seen as 'containers'
    - customer responsible for management and security of
        - managing network access security
        - platform level IAM
    - examples: RDS, EMR, elastic beanstalk
    - provide greater control & responsibility to customer 
- abstract service characteristics 
    - service is removed (abstracted) from the platform or management layer
    - accessed via endpoints using AWS APIs (typically not assigned AZs)
    underlying infrastructure, OS, platform - managed by AWS
    - provide a multi-tenant platform on the underlying infra
    - data isolated via security mechanisms
    - strong integration w IAM
    - examples: S3, DDB, Glacier, SQS
- AWS shared responsibility model 
    - which security controls are AWS responsibilities and which are the customers
    - boundaries vary b/w services 
    - three models
        - infrastructure service model
            - AWS: security of the cloud (foundation services, global infra)
            - customer: security in the cloud (data, IAM, OS config, encryption)
            - how and when to apply security controls is not AWS' responsibility
        - constainer service model
            - AWS: platform & app management, OS & network config, foundational services, global infra, endpoints, AWS side of IAM
            - customer: client-side data encryption + integrity, network traffic protection, firewall config, customer side of IAM
        - abstract service model 
            - AWS: all of above, plus network traffic protection + SSE
            - customer: customer data + client-side encryption + data integrity
## Security Controls 
### Data at Rest and in Transit
- protecting data at rest in EMR
    - EMR: managed service by AWS, highly-scalable cluster of ec2 instances to run big data frameworks
    - does NOT encrypt data at rest by default 
    - can use DDB or S3 as persistent store 
        - can copy from there or store on local disks 
        - can use SSE-S3/KMS if using S3 
            - able to choose to encrypt data at rest, in transit, or at rest and in transit 
            - can reuse security configuration of one cluster for other clusters 
    - mechanisms to implmement protection of data at rest in local disks
        - enable local disk encryption for EBS w/n EMR 
            - LUKS: linux unified key setup
            - open-source HDFS encryption 
                - secure hadoop RPC
                - data encryption of HDFS block transfer 
- protecting data at rest in RDS
    - during creation, can enable encryption under advanced options > database options 
        - keys can be managed by KMS using AES-256
    - platform-level encryption
        - oracle and SQL server transparent data encryption (TDE): comes with a minor performance hit 
        - MySQL cryptographic functions
        - microsoft SQL - transact SQL cryptographic functions 
- protecting data at rest in S3 
    - securing the availability and reliability of data
        - by default, s3 replicates objects across ALL AZs w/n region 
        - to protect against accidental or malicious deletion, implement versioning
            - version control objects
            - recover from unintended actions
            - uses add'l S3 space + increases cost 
            - can't be turned off, only disabled after being turned on
- protecting data at rest: Glacier & DDB
    - by default, Glacier encrypts data at rest using SSE
        - each archive generates a new key and the data is encrypted using AES-256
    - data can also be encrypted before storing it on Glacier
    - DDB supports SSE using KMS and is enabled by default 
        - no option to enable or disable encryption at rest 
- protecting data in transit in RDS
    - SSL/TLS: implementation depends on DB engine
    - oracle can use NNE, which is not compatible w SSL/TLS
- protecting data in transit in EMR
    - open-source HDFS encryption: provides hadoop encryption option
    - hadoop mapreduce encrypted shuffle uses SSL/TLS
    - communications to DDB + S3 sent over HTTPS
    - connect to EMR cluster for admin purposes using SSH
- protecting data in transit: elastic beanstalk
    - HTTP over SSL/TLS (HTTPS) w signed certificates 
        - will be encrypted from client to route53 to elb, then regular http to apps
- protecting data in transit: abstract services
    - S3
        - encryption in transit managed by AWS
        - uses HTTPS and SSL/TLS connections
    - DDB
        - when accessing DDB over internet, connections should be using HTTPS to ensure data encrypted 
- protecting data in transit when using the management console
    - the console uses SSL/TLS b/w browser and AWS service endpoints in addition to using X.509 cert
    - SDKs, AWS CLI + AWS API calls not from console are RESTful APIs over HTTPS
### Network Segmentation
- network traffic protection is under customer's responsibility in container services 
- public & private subnets
    - subnets: segment VPC into different networks
    - able to refind security profile for different services in different subnets 
    - public subnets: have IGW on route to 0.0.0.0/0
- route tables
    - route b/w two or more network segments
    - define which subnets can talk to which other subnets
    - helps isolate traffic b/w subnets 
- NACLs
    - provide rule-based tool for controlling ingress and egress network traffic at protocol & subnet level
    - NACLs are attached to one or more subnets w/n VPC
    - default NACL allows traffic in and out
    - stateless; do not remember outbound connections
- security groups
    - work at instance level
    - associated w instances and provide security at protocol and port access level
    - there are no deny rules - if traffic isn't explicitly allowed, it is denied 
- NAT (network address translation)
    - allow proviate instances to have outgoing connectivity to the internet & block inbound traffic from the internet (except for response to outbound traffic)
    - resides w/n public subnet
- bastion host
    - sit w/n public SN accessed via secure connection
    - act as 'jump' server, allowing connection to private instances from internet 
    - should be locked down as much as possible 
- network security: RDS
    - RDS instances should be located w/n private subnet w/n VPC, removing exposure to the internet 
    - also helps trim down on how comprehensive a single NACL needs to be, e.g., DB SN NACL only needs to allow DB ports 
- network security: elastic beanstalk
    - can use all the above network security controls
    - beanstalk has the option to manage updates to underlying platform, OS and web and app server updates 
- network security: EMR
    - automatically uses some VPC security groups
        - during EMR job, will launch two EC2 security groups
            - SG for master node and for slaves 
        - EC2 instances used by EMR w/n cluster should be located w/n private subnet 
- network security (abstract services): DDB/S3/SQS
    - DDB: most of security, ops controls, underlying maintenance is AWS responsibility of AWS 
        - auto hardware failover
        - data replication
        - network inspections
    - S3, SQS
        - network security controls + mgmt managed by AWS
        - controlling who has access to these services is customer's responsibility via IAM
### IAM
- can configure conditional access & allowing only during set time periods or from specific IP address 
- IAM w RDS
    - any authenticated identity w appropriate perms can access RDS
    - granular perms can be granted
- IAM w EMR
    - access to clusters and to data itself managed
    - by default, EMR clusters restricted to the IAM user who created 
        - there is an option to make cluster visible to all users if required
    - can use AWS managed policies 
- S3 access controls 
    - add'l resource-based access control
        - bucket policies
        - access control
    - if there are conflicting perms b/w IAM and resource perms, least privileged access will be granted 
- IAM w DDB
    - can granted access to specific rows w/n DDB table
### Built-in Service Security Controls 
- RDS
    - offeres durability and available of data thru multi-AZ feature
        - will automatically configure a secondary DB of primary DB in different AZ 
    - automatic backups & snapshots
        - auto backups enable point-in-time recovery
        - can create snapshot of entire database (must be triggered by user)
- S3
    - MFA delete 
        - enforces add'l security measures to be used when object w/n bucket is set for deletion 

# Exam Review
- CloudTrail logs to CW logs group; remember, CW has logs group and log streams. CT needs to be able to CreateLogStream and PutLogEvents
- IAM passwords: can enforce complexity, expiry date, disable reuse, allow pw self service, and force users to contact account admin when their pw has expired 
- CW metrics: RDS sends metrics to CW every minute by default. So does SNS. EC2 + ASG are 5 minutes by default 
- CloudHSM HA group unable to communicate b/w members. Recover automatically w LunaSlotManager.reinitialize()
- Route53 and CFt have built in protection against SYN/ACK floods, UDP floods, reflection attacks and DNS query floods 
    - WAF is for apps behind R53, not for R53 itself 
- in AWS Directory Service, set up AD connector directory to existing MS AD to allow SSO for users 
- CloudTrail can be used to filter by access key to see API requests & see if any were suspicious & disable the applicable keys 
- use Trusted Advisor to determine if a security alert has been generated for lambda functions with runtime approaching depreciation 
- sharing golden images in AWS organization: enable sharing w/n org, create resource share in AWS Resource Access Manager to share images across org 
- if 2/3 CloudHSM instances go down, HSM can still maintain service 
- CFt: if logging enabled, CFt records info about each end-user request for an object & stores the files in the specified S3 bucket 
- KMS: can define data classification levels & have multiple keys per level. Recommended to use it and have at least one key per level 
- CT: logs events from all regions in account
- VPC flow logs can be configured to capture all traffic, accepted traffic only, or rejected traffic only 
- API gateway automatically protects backend from DDoS attacks, either layer 7 counterfeit requests or layer 3 SYN floods. AWS Shield Advanced can protect at layers 3, 4, 7. Route53 can protect against DNS DDoS attacks, but doesn't protect entire layers 
- to use a third-party authentication service (like Okta) with AWS, can use cognito. For MS AD, use AWS Directory Connector 
- GuardDuty is an intrusion detection service that monitors AWS account + resources for malicious activity. Can detect & can be configured to have automatic remediation
- Config is used for configuration audits of resource. Cannot automatically remediate, but can send notifications 
- HSM: public key installed on HSM appliance during provisioning 
- invalid principle in policy: not an issue with the S3 bucket arn, but relating to IAM user or the value in principle is the wrong type 
- Amazon Client VPN can allow secure login w corporate credentials to both AWS and on-prem resources
- AWS SSO secure user portal is use to manage access to multiple AWS accounts & business apps. Able to host a personalized portal to give users easy access to AWS accounts + authorized apps 
- with resource based policies, can define permissions for sub-directories of bucket separately
    - not managed policies. Read the Question!  
- WAF used to protect APIs and apps from common web exploits + bots that affect availability/security
- inspector: able to create assessment targets for different instance tags + run different rules packages in those different assessment targets 
- in CW when creating metric filters for CT logs, must create 'filter pattern' that determines what CW should monitor + extract from CT logs 
- when locking down instances, can also use linux iptables-host based restrictions on the instances to act as a firewall & another layer of security 
- when using security hub, can enable it and turn on integrations for AWS native security tools and partner integrations 
- AWS resilience hub: define, validate, track resiliency of AWS app
- AWS control tower: enforce + manage governance rules for security, ops, and compliance at scale across all orgs + accounts in AWS 
- AWS incident manager: part of SSM that enables creation of incident plans to allow for faster resolution of critical app availability + performance issues 
- when using CloudHSM HA config, failed/lost group HSM can be reinstated by hands-off (HA recovery on) or manual (HA recovery off)
- GuardDuty exfiltration finding would look something like 'Exfiltration:/IAMUSER/AnomalousBehavior' 
- if concerned about data security, can also use OS tools to encrypt file systems on EBS volumes (seems a little redundant?)
- don't be too pedantic about the questions. They're usually not trying to be *that* sneaky. if traffic is working inside the network, and there's NACLs involved, it's probably a NACL issue with outbound ports 
- cloudHSM: `aws cloudhsm describe-hsm` retrieves info about an HSM, including ENI addr + secret access key (aka public key)
- VPCs: read the question! private subnets to NAT gateways for internet comms. Public subnets to IGW, VPN traffic to VPGw
- CT log naming: acctID_CT_Region_dateTime_uniqueString.FileNameFormat 
- can tag findings in inspector with key-value attribute to each finding according to customer policy (in addition to inspector findings severity)
- instance store data remains when instance reboots. Stopping, terminating, or underlying hardware failure causes loss of data in instance store volume 
- can use config to enforce proper AMIs are used 
- safest process to delete existing KMS keys is to use the full 30-day waiting period before deletion
- KMS keys can operate in multi-region scope, but AWS recommends region-specific keys for most cases 
- AWS inspector is used to check network accessibility and security vulnerability of EC2 instances, container images, and security state of apps running on those resources
    - can have it scan ECR & review findings for container images w vulnerable OS packages 
- CW events rules can trigger based on CT calls, even if the question words it as just 'AWS API calls' & can quickly submit events into Kinesis Streams
- can use trusted advisor to determine if security alert has been generated for origin servers that have SSL certs that are expired, about to expire, missing, or that use outdataed encryption
- CloudWatch Events do things in response to APIs; alerts for CT services are set up and triggered through CW 
- can create IAM credential report as often as every 4 hours. If new report requested, if none are newer than 4 hours, a new one is automatically generated 
- REMEMBER TO READ & UNDERSTAND THE QUESTIONS

# AWS Partner Certification Readiness: Security - Specialty
## AWS Security Fundamentals 
### Introduction
- design principles
    - implement a strong identity foundation
        - least privilege, separation of duties
    - enable traceability
        - monitor, alert, audit actions & changes
    - apply security at all layers (defense in depth)
    - automate security best practices
    - protect data in transit and at rest
    - enforce the principle of least privilege 
        - start w deny all & grant access as needed 
    - prepare for security events 
        - have an incident management process that aligns w org req's 
- shared responsibility model
    - AWS is responsible for:
        - protecting global infrastructure that runs services
            - hardware, software, networking, facilities
    - customer is responsible for  
        - securing data, OS, networks, platforms & resources created in AWS 
        - protecting confidentality, integrity, and availability of data 
### Security of the cloud
- AWS Global Infrastructure: 102 AZs, 35 regions w 12 AZs & 4 regions to come
- compliance and governance
    - AWS artifact
        - no-cost, self-service portal for access to AWS security & compliance reports + select online agreements
            - includes Service Organization Control (SOC) reports, Payment Card Industry (PCI) reports, and certs from accreditation bodies across the world 
### Security in the cloud 
- everything happens through API calls 
    - every interaction is authenticated 
- IAM
    - authentication: AD, SAML, rotating credentials
    - authorization: permissions to do the tasks needed
    - authentication is critical, by ensuring each operator only has authorization to do the tasks they need to keeps the risk to a manageable scope 
    - Add'l IAM services
        - AWS Secrets Manager
            - centrally manage secrets for resources on AWS, on-prem, & third-party services
            - replace hardcoded creds in code w API call to secrets manager 
            - can rotate secrets on defined schedule 
        - AWS IAM Identity Center (Formerly AWS SSO)
            - allows for central management of SSO access to multiple accounts & business apps 
            - users can sign into a portal w existing corp creds & access assigned resources from one place
            - includes built-in SAML integrations + can integrate w MS AD 
        - AWS STS 
            - enables request of temp, limited-privilege credentials for IAM users assuming a role or for federated users 
        - AWS Directory Service (for MS AD)(aka AWS Managed MS AD)
            - enables domain workloads + AWS resources to use MS AD in AWS
            - built on actual MS AD
            - does not require sync or replicate data from existing AD to cloud 
        - AWS organizations 
            - centrally manage & enforce policies for multiple AWS accounts 
    - Amazon Cognito 
        - add user sign-up, sign-in + access controls to web & mobile apps 
        - define roles & map users to role so app can only access resources authorized for each user 
        - sign-in can be done by third-part or directly via cognito 
        - user pool: user directory that handles the tokens returned from social sign-in providers 
            - after successful user pool sign-in, app will receive user pool tokens from cognito
            - tokens can retrieve AWS creds from cognito identity pools
- detective controls 
    - cloudtrail
        - enabled by default on AWS account 
        - recommended to export CT logs to another account where no user from the tracked account has access so that event forensics can know for sure logs weren't tampered with 
        - to enable for org, must be in mgmt acct 
    - cloudwatch
        - can use to route events + info of potentially unwanted changes into a proper workflow
    - auditing
        - S3 server access logs
            - contain details like request type, resources requested & date + time request was made 
        - ELB access logs
            - capture detailed info about each request: IP address, latencies, server response
            - can analyze traffic patterns & troubleshoot issues 
        - CW logs + events 
            - monitor & troubleshoot all operating systems + apps in AWS env 
            - monitor logs for specific phrases, patterns & values 
        - VPC flow logs
            - audit connectivity + security issues
            - can ensure network access rules for a VPC and config'd properly
            - capture info about IP traffic going in/out of network interfaces & subnets 
        - CT 
            - obtain history of API calls made to account via console, CLI, SDKs, other AWS services 
    - services for detective controls
        - GuardDuty
            - intelligent threat detection service
            - continuously monitor + protect AWS accts + workloads
            - identifies suspected attackers through integrated threat intelligence feeds + uses ML to detect anomalies
            - monitors for unusual API calls or unauthorized deployments that indicate compromise or direct threats like compromised instances or reconnaissance by hackers 
        - Trusted Advisor 
            - draws upon best practices
            - inspects AWS env + makes recommendations for 
                - saving money
                - improving system performance
                - closing security gaps 
            - business + enterprise-level support get access to full suite of TA best-practice checks 
        - AWS security hub
            - single view of high-priority security alerts + compliance status across AWS accts + multiple services 
    - AWS config
        - continuous monitoring + assessment service that help detect non-compliance configs in almost real-time 
        - can view current/historic configs of resource + use to troubleshoot outages or analyze security attacks 
        - can continuously run assessment checks on resources to ensure compliance w security policies, best practices, compliance standards 

### AWS Partner Certification Readiness: Security Specialty | Week 1 Content Review 
- VPC 
    - regional vs vpc services
        - regional: DDB, S3, etc 
        - vpc: EC2, lambda, RDS, redshift, etc
    - security groups
        - stateful firewall (remembers ephemeral ports from existing connections)
        - only supports allow rules 
        - network adapter level
        - default deny all
    - NACL
        - stateless firewall
        - default allow all
        - filter traffic on subnet level 
    - VPC endpoints
        - keep AWS traffic private w/n AWS private network 
        - connect VPC to supported AWS services
        - interface endpoints use Privatelink
            - include some AWS managed services, services hosted by other AWS customers + partners in their own VPCs & supported AWS marketplace partner services 
        - gateway endpoints (do NOT use privatelink) targets specific IP routes in a VPC RT & is used for traffic destined to DDB or S3 
- AWS Compute
    - EC2
        - desire lots of control over configuration
        - configure servers, storage, networking, OS
    - ECS
        - run servers, config apps and control scaling in containerized fashion
    - Fargate
        - run containers in serverless fashion
    - Lambda
        - serverless, event-driven compute service
        - temporary compute 
- CloudFront
    - securely deliver content w low latency + high transfer 
- Route53
    - can be used to direct traffic to CFt endpoint 
    - and in blue/green deployments
    - can eliminate certain countries/IP addresses from accessing environment
        - can change routing based on IP address & geographic location 
- IAM
    - controls who can access what 
        - who: person, role, resource 
        - what: resources in scope to allow access 
    - ARN: uniquely identify AWS resources
        - depending on the resource, formed slightly differently 
    - policy types
        - identity-based policy: assigned to a 'who', i.e. user, role
        - resource-based policy
            - if a principal is listed in the policy, then it's a resource policy (identity policies are assigned to the identity, and don't need to specifically define it again)
        - policy interpretation
            - statement: has been 2012-10-17 with no expectation of change
            - resource policies
                - prinicipal lists who gets access 
    - STS used when a role is assumed 
    - VPC flow logs need the correct permissions to be able to write to CW 
        - flow logs need to be able to create, put, and describe logs groups
        - plus a trust policy which allows it to assume the role 
- S3 
    - storage classes
        - S3 intelligent-tiering
        - S3 standard
        - S3 standard-IA
        - S3 glacier
        - S3 glacier deep archive 
        - S3 one zone-IA
            - use cases where if the data is lost, could be rebuilt 
        - S3 outposts 
            - local device sent to on-prem
    - lifecycle
        - transition actions
            - define when objects transition to other S3 storage classes as they age
        - expiration actions
            - define when objects expire
            - S3 deletes expired objects on your behalf 
    - bucket policies
        - resource policies, but specific for S3 
    - versioning 
        - objects are never deleted; old versions retained 
    - object lock
        - compliance mode
            - store compliant data
            - data CANNOT be written by anyone until compliance date is passed
            - even root cannot delete object
        - governance mode
            - store data in write-once-read-many (WORM) format
            - privileged users can modify retention controls
        - legal hold
            - unsure of how long objects should stay immutable 
    - encryption
        - all new S3 buckets are encrypted by default, but can be disabled
        - SSE-S3, SSE-KMS, SSE-C
    - block public access
        - by default, all objects are private 
        - buckets have to be intentionally opened up
### AWS Partner Certification Readiness: Security Specialty | Week 3 Content Review
- AWS Config "rules & compliance"
    - looks across entire environment & makes sure resources are compliant with rules defined 
        - notified when resources go out of compliance
    - only looking at infrastructure; don't have visibility into application 
    - key concepts/features
        - configuration history of AWS resource
            - can go back and look at any resource and see what all changes occured in the lifetime, even for things that have been terminated 
        - configurable and customizable rules
            - built-in and custom rules able to be used 
            - conformance pack: grouping of rules 
                - rules grouped together that can all be applied in an environment 
- GuardDuty "suspicious events"
    - like a guard in the bank constantly looking around monitoring the environment 
    - actively aware of what's going on in AWS environment & watching for suspicious things 
        - can see APIs, deployed resources, etc 
    - threat detection types
        - reconnaissance
        - instance compromise
        - account compromise 
        - sends alerts to Amazon EventBridge 
            - eventbridge used to take action on GD findings 
                - i.e. can use an event to trigger lambda 
            - EB for routing the events, Lambda/misc for handling the events 
- Inspector "vulnerability"
    - automatically discovers and scans for software vulnerability 
    - can also identify libraries that lambda uses 
    - can trigger security hub, eventbridge, or write data to s3 
        - eventbridge can only operate on a single notification. If needing additional context around that event, use security hub 
    - uses SSM agent to identify vulnerabilities on instances
        - can integrate w SH to take the finding & invoke custom actions, including SSM runbook 
- Systems Manager Incident Manager 
    - response plans 
        - triggered by EventBridge event or CW alarm 
    - runbook automation
        - kick of basic automated responses 
    - engagement and escalation
        - send notifications to make sure everyone involved has visibility 
    - active collaboration
        - can integrate with AWS chatbot to keep track of collaboration 
    - incident tracking
- Security Hub 
    - cloud security posture management service
    - performs security best practice checks, aggregates alerts, and enabled automated remediation
        - aggregates and scores finding
            - user has control over how scoring occurs 
    - config: how it was set up
    - security hub: how it is presently in the environment today
    - security hub findings can trigger eventbridge to perform work 
    - runs on AWS, but can pull findings from other sources 
- Not on exam: security lake
- Detective 
    - analyze, investigate & quickly identify root cause of potential security issues or suspicous activities 
- CloudTrail "logging"
    - does all the auditing and monitoring of API activity
- CloudWatch "monitor & alert"
    - collects API information and acts on it 
    - CW logs: SLA is 15 minutes
        - there is a delay between when a thing happens in the environment to when it appears in the logs 
        - can also put custom logs like app logs 
        - can pull data from on-prem or cloud devices w cloudwatch agents 
    - pulls log events from cloudtrail
    - log stream
        - sequence of log events that share same source
    - log group
        - groups of log streams that share same retention, monitoring, and access control settings
    - retention settings
        - how long log events kept in CW logs (doesn't affect how long logs remain in CT)
- VPC Flow Logs
    - capture info on what's going into and out of a network
    - does NOT capture what is IN the packets
    - can run on instance, subnet, or VPC 
- centralized logging w opensearch
    - collect, ingest, and visualize log data from various sources 
    - provides web-based console 
- logging best practices
    - set up cloudtrail that gets logged to a dedicated and centralized s3 bucket
        - best to write organizational logs to an archive account
    - use SSE-S3
    - enable MFA delete on s3 bucket to avoid accidental deletion
    - use least privilege
    - configure object lifecycle management
    - use file integrity monitor when logging
        - writes hash value for each record + hourly digest that includes all records written. 
        - helps identify if logs get tampered with 
    - versioning not required, but doesn't hurt to enable (except for a slight cost increase), more for defense in depth protection of logs in s3 
- S3 object lock: store data in WORM (write once, read many) format
    - compliance mode
        - can't change anything
        - can be helpful for logs, so they can't be changed 
    - governance mode
        - privileged users can modify retention controls
    - legal hold
        - if unsure how long objects should stay immutable
- Trusted Advisor "Recommendations"
    - inspects AWS env and makes recommendations for saving money, improving system performance, or closing security gaps
- Audit Manager 
    - continually audit AWS usage to simplify managing risk and compliance w regulars & industry standards 

## AWS Best Security Practices: Network Infrastructure
- VPC
    - gateway endpoint
        - route table target for S3 or DDB 
- DNS
    - DNSSEC
        - domain name system security extensions
        - strengthen security of DNS protocol by providing authentication using digital signatures
        - helps prevent DNS attacks like DNS cache poisoning and DNS spoofing 
        - if using in public hosted zones, will need to store cryptographic keys, which the authentication is based on
- network security
    - network firewall
        - managed service that provides
            - stateful firewall
            - web filtering
            - intrusion protection
            - central management and visibility
            - rule management and customization
            - partner integrations 
- security services
    - AWS shield
        - always-on network flow monitoring to defend against L3 & L4 DDoS attacks 
        - shield advanced also includes
            - tailored detection based on app traffic patterns
            - health-based detection
            - advanced attack mitigation
            - visibility & attack notification
            - DDoS cost protection
            - proactive event response 
                - SRT: shield response team 
            - also protects (customers also get WAF + firewall manager for protected resources)
                - CloudFront distributions 
                - R53 hosted zones
                - Global Accelerator
                - ALBs
                - ELBs
                - EC2 EIPs
    - AWS WAF
        - L6 & L7 DDoS attacks
        - can filter based on 
            - IP address origin of request
            - country of origin of request
            - regex
            - size of particular part of request
            - malicious SQL code or scripting 
    - Firewall Manager
        - streamline & standardize management of firewalls deployed across accounts 
        - integrated w AWS organizations to manage the following across multiple accounts 
            - WAF rules
            - shield advanced protections
            - VPC SGs
            - network firewalls
            - R53 resolver DNS firewall rules 

- "Proceed to AWS Security Best Practices: Network Infrastructure Hands-On Lab from Skillbuilder."

## Automatically Mitigate Account Compromise Issues 
- AWS Health
    - provides visibility into performance & availability of AWS services & accounts
    - powers AWS personal health dashboard (PHD)
    - must carefully structure AWS orgs to maximize usefulness of PHD
- AWS Risk
    - how it works
        - detects compromise
            - AWS continuously monitors public repos to detect exposed credentials & customer accts to identify abnormal usage
            - AWS fraud team verifies anomalies to reduce false positives
        - notifications sent
            - support case auto generated & copied to root email + security contact
            - event generated in PHD
            - CW event generated 
        - mitigation steps taken to protect account 
            - AWS compromised key quarantine policy may be applied to restrict IAM user from some actions 
            - account owner should take action on the identified IAM user 
- to take full advantage of AWS Health service requires at least Business Support, and the org must be config'd for all features mode 
- events can be sent across accounts, but NOT regions 
- CloudWatch EventBridge permissions
    - per account
        - not recommended
    - per org
        - recommended 
    - open to all 
        - allow every account to send management events to main account 
        - security risk if anyone can send events if they know account ID
        - if malicious actor wants to flood acct w events, must know account id + setup on the backend 

## Week Three Exam Prep
- question 1
    - security engineer monitoring AWS acct for changes to compliance rules. EC2 must be launched from specific AMIs & EBS volumes must be encrypted. non-compliant instances must be terminated
- answers for 1
    - monitor compliance for AWS Config rule 
    - set up EventBridge based on amazon inspector findings
        - inspector can't check what AMIs were used to launch instances
        - inspector looks at network vulnerabilities 
    - set up custom remediation action w SSM automation runbooks 
    - set up EventBridge based on trusted advisor metrics 
        - TA doesn't integrate w EventBridge 
    - invoke CLI command from EventBridge to terminate infrastructure 
        - CLI isn't a target for EventBridge
- question 2
    - using ECS for EC2 requires SSH/instance access of some sort to manage the cluster
    - systems manager runs over HTTPS 
- question 3
    - security team creating response plan in event of unauthorized actions performed on AWS infrastructure. Want to include steps to determine if employee's IAM perms changed as part of incident
- answers for 3
    - use config to examine IAM perms before/after incident
        - part of the use-case of config 
        - if employee changed their permissions intentionally, they likely would have changed them back. Able to look through the whole cycle of events, and see changes during event 
        - (these events would also show in cloudtrail, but wouldn't know what specific permissions got changed)
    - use Macie to configure IAM policies as custom-defined sensitive data type
        - Macie looks for PII in S3 to prevent leaks 
    - use IAM access analyzer to examine IAM perms before/after incident
        - tells where resources are over-exposed to people outside of environment
        - does not keep history
- question 4
    - teams wants to automate patching instances to remain compliant within 7 day patch window
- answer for 4
    - enlist all instances in SSM patch manager patch group; use patch manager to create patch baseline; configure maintenance window to apply baseline 
- question 5
    - using cloudtrail to log all API activity for all regions & all their accounts. Wants to protect integrity of log files in a central location. What steps to protect log files from alteration (select two)
- answers for 5
    - create central s3 bucket in dedicated log account. in member accounts, grant CT access to write logs to this bucket 
        - implies orgs are set up
    - enable AWS orgs for all AWS accts. Create SCP to enable CT in each member acct w logs directed to central s3 bucket 
        - kinda does what A does w the central bucket
        - SCP (service control policies) set up guardrails applied to IAM policies to restrict actions of member accounts 
    - enable server access logging on s3 buckets 
        - doesn't log API activity; only tracks people who have accessed bucket, but not what they did
    - use SSM compliance to continually monitor access policies of s3 buckets containing CT logs 
        - scans instances & looks for instance config. Doesn't look at access policies
    - enable AWS orgs for all AWS accts. enable CT w log file integrity validation while creating org trail. Direct logs from trail to central S3 bucket
        - log file integrity validation: hash of every log written, and hourly digest of files written 
        - cloudtrail organization trail is a thing 
- question 6
    - engineer pings instance, but doesn't receive response. flow logs output listed. Traffic from instance out is being rejected
- answer for 6
    - check outbound rules of NACL for deny
    - other options are check SG for deny (which it doesn't support) or check NACL for inbound deny, which isn't the issue 

# Getting Started with Security Hub
## Introduction to Security Hub 
- security hub
    - cloud security posture management service
    - performs automated, continuous security best practice checks against AWS resources 
    - can understand security posture w score across all AWS accts + regions 
    - ingests security findings from AWS services + partners 
- benefits
    - reduced effort to collect + prioritize findings
        - processes finding data using standard finding format
        - correlates findings across providers 
    - automatic security checks against best practices + standards
        - runs continuous, account-level config and security checks based on AWS best pracitces + industry standards 
    - consoldiated view of findings across accounts and providers 
    - automated remediation of findings 
        - integrates w EventBridge 
- pricing
    - based on quantity of checks + quantity of ingested findings each month 
## Architecture and Use Cases
- when activated, begins to consume and aggregate findings from AWS services that are enabled
    - services like GuardDuty, Macie, Inspector, Detective, IAM access analyzer, WAF/firewall manager 
    - also integrates w third party ticketing, chat, incident management, threat investigation, plus GRC, SOAR, and SIEM tools
- can have security hub account w/ or w/o organizations
    - w/o, simply invite other accts
    - w/, designate a single account as security hub 
    - administrator and member accounts. Can only be one. 
- aggregation region
    - view security findings from multiple regions
    - view and manage findings in aggregation region from linked regions 
- archived finding
    - finding w a RecordState set to ARCHIVED
    - indicates the finding provider believes that finding is no longer relevant 
- Workflow.Status
    - NEW, NOTIFIED, SUPPRESSED, RESOLVED are some of the states it can be in 
- security control
    - check against a specific resource 
    - contains control details
        - include control status + generated findings for the control
- security standard 
    - set of related controls to determine compliance 
    - details page for standard includes list of controls in the standard + the overall score
- security check
    - determines whether resources are in compliance w/ control requirements 
    - running check producing finding that specifies point-in-time status of a single resource: passed, failed, warning, not available 
- finding
    - observable record of security check or security-related detection 
    - processes these findings using the AWS Security Finding Format 
- insight
    - collection of related findings defined by aggregation statement and optional filters 
    - identifies security area that requires attention & intervention
    - some default insights offered by security hub 
- use cases
    - reduce risk w automated, continuous security checks
        - set of auto controls called AWS foundational security best practices standard
            - vetted by AWS security experts 
        - provides security score of 0-100 for each standard & each account, plus a total score for all accts associated w admin account 
    - consolidate findings across AWS services + partner integrations
    - automate response and remediation

# AWS Partner Certification Readiness: Security - Specialty | Week 4 Exam Strategy 
## Missed topics coverage
- Cognito
    - provides authentication, authorization, and user management for web AND mobile apps 
    - user pools
        - users authenticate to env that is set up
        - anything they do against an AWS service goes through the user pool
        - can use local or identity federation to allow sign in and get a token
            - app exchanges that token for credentials in the *identity pool* & uses those credentials to access AWS services
        - able to set up MFA and MFA through federation provider 
        - lots of hooks can be used to 'interrupt' the workflow to allow more granular controls 
        - email address and user ID (among other things) stored in the pool
            - can either populate the pool or allow users to create users for the pool 
    - identity pools 
        - exchange tokens for AWS credentials 
- Resource Access Manager (RAM)
    - securely share AWS resources 
    - set up resources in one AWS account and directly share them with other AWS accounts
        - can share things across organizations (don't have to be w/n org)
    - main use case: centralize management of resources shared b/w accounts
        - can also use for governing resources
        - e.g. sharing the same VPC across multiple accounts & allowing other accounts to build in the VPC 
    - often used in organizations, but DOES NOT have to be
    - to tell if the resource is shared, must look at the ARN, and if it shows a different account number, or in RAM
## Questions
- question 1
    - company using AWS org. Wants to implement automated solution to detect when new or existing S3 buckets in any acct or region made public. must respond by blocking public access. Must also detect and respond to changes in ACLs and bucket policies
- answers for 1 
    - needlessly complex: usually a sign it's not the answer 
    - using org trails w cloudtrail is good, but the way the answer is worded, EventBridge is only used in the designated security account and NOT reading cloudtrail 
    - when turning on EventBridge on s3 buckets, bucket ACL and bucket policy changes NOT sent to cloudtrail 
    - the right answer: use config (which is used to detect if something doesn't meet a predefined rule) to detect public access in object ACLs, bucket ACLs, and bucket policies. use an automated remediation action for the rule. Use SSM automation runbook to remove public access on misconfig'd S3 buckets 
- question 2
    - responding to DDoS targeting dynamic website on EC2 behind cloudfront. Attack is from many IP addresses. Attack query strings have common misspelling in query strings
- answers for 2 
    - WAF: layer 6-7 DDoS, Shield layer 3-4
    - WAF ACLs + associate w cloudfront 
- question 3
    - company wants to enable SSO so that employees can sign into AWS console by using company's SAML provider
- answers for 3
    - can only map corporate groups to IAM policies; cannot map corporate (aka SAML) users to IAM users 
    - a role must be set up that establishes a trust relationship b/w IAM & corporate SAML IdP
- question 4
    - company wanting to share s3 bucket w vendor for vendor to analyze log files in S3. Company created IAM role that grants access. Has also set up trust policy. What info is required as argument in the API calls to access S3 bucket 
    - the question: what are the required steps to get into the bucket, but the answers are asking how to assume the role 
- answers for 4
    - temporary access keys are not meant to be shared; that's the purpose of roles 
    - for assuming a role, don't need ARN of the trust policy
        - ask, what's the purpose of the trust policy, which is just to give permission to assume role; safe to throw out 
    - need the ARN of the role to be able to assume the role (think of how it works in the console)
    - external ID provided by vendor to the company
        - particularly when coming from the outside to assume a role, must have shared the external ID with the company whose environment you're trying to get in so that their policy can allow your account 
        - 'confused deputy': https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html 
        - external ID: random string of characters for identifying other accounts
            - trust other account, and require that the external ID is passed in; that way, malicious users wouldn't be able to assume the role with just a role and account ID 
            - https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html
            - do not hard code external IDs! 
    - name of bucket policy of bucket in company's account
        - don't need this; policy doesn't say anything about authority
    - this was a question of knowing the wrong answers and being able to slim down to what are the correct answers 
- question 5
    - company w dev + prod accts in AWS orgs wants to make sure users in prod accts are not allowed to modify or update KMS encryption keys
- answer for 5
    - SCP + an OU for the specific account is what they were designed to do 
    - config can't check to see if an IAM policy is assigned to a user 
    - SCPs affect IAM users + roles, but NOT resource based policies (i.e. ec2 instance or s3 bucket) 

# Deep Dive with Security: IAM
- Attribute-based access control (ABAC) (in contrast to role-based access control)
    - authorization strategy that defines permissions based on attributes (aka tags)
    - w attribute-based perms, can manage tags from multiple projects & it scales w new tags added to new resources 
- IAM condition keys 
    - can use condition element to compare keys in the request context w key values specified in policy 
- global condition keys
    - start w aws: prefix
    - used in restricting access 
        - to a certain period of time (CurrentTime, EpochTime, TokenIssueTime)
        - by enforcing an extra layer of security during authentication + data transmission (MFA age, MFA present, SecureTransport)
        - based on source of request (SourceAccount, SourceArn, SourceIP, SourceVpc, SourceVpce, VpcSourceIp)
        - based on principal making request (PrincipalAccount, PrincipalArn, PrincipalOrgId, PrincipalOrgPaths, PrincipalType)
        - using attributes (tags) to control access (PrincipalTag, RequestTag, ResourceTag, TagKeys)
        - more granular level of control (Referer, RequestedRegion, UserAgent, userid, username, ViaAWSService)
- Advanced Policy Elements
    - strongly recommended to avoid using a 'Not*' and "Effect": "Allow" in the same statement 
        - in part because bad actors could inadvertently allowed in
    - NotPrincipal  
        - cannot be used in an IAM identity-based policy
        - can be used in trust policies for IAM roles and resource-based policies 
    - NotAction
        - by using NotAction (rather than deny) can list a few actions that shouldn't match, and the options not listed are then allowed 
    - NotResource
- STS
    - temporary credentials consist of an access key ID, secret access key, and a security token 
        - each time a role is assumed, a set of temp security creds are generated + IAM role session created 
    - default security credentials last for 1 hour. Can provide values from 15 minutes to 12 hours 
- managing role sessions
    - session policies
        - inline permission policy that user pass into the sesson when assuming role 
        - benefits to admins:
            - reduce number of roles needed to create b/w multiple users can assume same role yet have unique session perms
            - set perms for users to perform only specific actions for that session
        - must have sts:TagSession action allowed in IAM policy
        - good for the duration of the role assumption (present as a key/value pair)
            - transitive tags can persist through sessions 
        - cannot pass session tags using the console
        - role chaining
            - use a role to assume a second role through CLI/API
            - by default, tags are not passed to subsequent sessions
                - able to set session tags as transitive & pass to subsequent sessions in a role chain
                    - must set tags as transitive in the CLI command used to assume the role 
            - useful to impose guardrails against self or admin to prevent accidental changes 
    - each IAM role session is unique identified by a role session name
- identity federation  
    - before app can call AssumeRoleWithSAML, SAML IdP must be configured to issue the claims AWS requires
        - must also use IAM to create SAML provider entry in AWS acct that represents IdP
        - must also create an IAM role that specifies the SAML provider in its trust policy 
    - AssumeRoleWithWebIdentity (think Cognito)
        - before app can call w API, must have identity token from supported IdP & create a role that app can assume 
        - does not require the use of AWS security credentials 
        - Cognito   
            - allows adding user sign-up, sign-in + access controls to web and mobile apps 
            - can define roles & map users to different roles so app can only access resources authorized for each user 
- IAM policy simulator
    - test and troubleshoot identity-based policies, IAM perms + boundaries, AWS orgs SCPs, and resource-based policies
    - does not actually make an AWS service request & is safe to test 
        - returned result indicates whether action would have been allowed or denied 
            - have to specify what actions & for what service to test against
- IAM access analyzer
    - continuously monitors policies for changes to catch issues as policies are added or updated 
    - able to proactively address any resource policies that violate their security and governance best practices 
    - generate IAM policies based on access activity in CT logs
    - identify resources in org & accts that are shared w external entities 
    - to enable, create analyzer for AWS acct or for entire org if using AWS orgs 
        - can only have one analyzer per region in acct 
    - supported resource types
        - IAM roles
            - checks to see if an entity outside zone of trust is allowed
        - check if S3 bucket policy, ACL, or access point gives access to external identity
        - AWS KMS keys
            - findings generated if key policy or grant allows external entity to access key
        - lambda
            - findings generated for policies that grant access to function to external entity
        - SQSQs
            - findings generated for policies that allow external identity to access Q
- viewing access history
    - can view allows AWS service information & allowed action information
        - includes date & time when attempt was made
        - to view last accessed info on console, go to IAM, pick a group/user/role, then go to Access Advisor tab 
    - considerations
        - tracking period: activity usually appears w/n 12 hours & up to 400 days are tracked 
        - iam:PassRole action is NOT tracked 
        - only the principal that generates a report can view the report details 
        - info for IAM includes services that are allowed by an IAM entity's policies 
            - policies either attached to a role or attached to a user directly or through a group
- troubleshooting with cloudtrail 
    - if a trail is created, enables continuous delivery of CT events to s3 bucket 
    - if trail not configured, can view most recent events in CT console -> event history

# AWS Certification Readiness: Security - Specialty | Week 4 Content Review
- AWS WAF (operates at layer 7)
    - configure rules that allow block or monitor web requests based on conditions:
        - IP addresses
        - HTTP headers
        - HTTP body
        - URI strings
        - SQL injection
        - cross site scription
    - can protect the following resources 
        - CloudFront Distrubtion
        - API Gateway REST API
        - ALB
        - AWS AppSync GraphQL API
        - Cognito user pool 
- AWS Shield 
    - managed service that provides protection against DDoS
    - classes of attacks that shield detects
        - network volumetric attacks (layer 3)
        - network protocol attacks (layer 4)
        - application layer attacks (layer 7)
    - enabled by default for AWS customers for regular DDoS attacks 
- AWS Firewall Manager 
    - security management service that allows central configuration & management of firewall rules across accts + apps in AWS orgs
    - simplifies admin & maintenance for
        - AWS WAF
        - AWS Shield Advanced
        - VPC SGs
        - network firewall
        - R53 resolver DNS firewall 
    - integrates & sends findings to security hub 
- VPC Network Access Analyzer
    - understand network access to resources in VPCs
    - can identify unintended network access relative to security & compliance req's to take steps to improve network security
    - able to demonstrate that network on AWS meets compliance requirements as needed 
- how customers connect to AWS globally
    - public internet (i.e. IGW)
    - IPSEC or SDWAN
        - connect securely from customer data center to aws network
    - Direct Connect
        - dedicated connection b/w colocation facility and AWS network 
        - Direct Connect Security w MACsec
            - layer 2 encryption for dedicated direct connect connection  
            - if needing encrypted connection with direct connect
            - secures ehternet connection b/w customer's edge device & AWS edge device 
- EC2 image builder
    - simplifies creation, maintenance, validation, sharing, and deployment of linux/windows images for use w EC2 & on-prem
    - source image -> customize software + config -> secure image w AWS-provided or custom hardening templates -> test image w AWS-provided or custom tests -> distribute golden image to selected regions 
- AWS SSM patch manager
    - automate process of patching instances
    - automate patching by defining rules for auto approval
    - scan & install patches on a regular basis w scheduled maintenance windows
    - view aggregate patch compliance using explorer 
- AWS orgs 
    - centrally manage & consolidate all AWS accts
    - can use SCPs (service control policies) to provide permission guardrails at the AWS org, OU, or acct level
    - when SCP attached to OU, it is inherited by the child OUs and accts under OU
        - SCPs do not grant any perms
        - SCPs specify max perms for AWS org, OU, or acct
    - SCPs affect only IAM users & roles managed by accts & are part of org
        - SCPs don't affect resource-based policies directly 
## IAM 
- IAM identity center (successor to AWS Single Sign-On)
    - securely create or connect workforce identities and manage their access centrally across AWS accts & apps 
    - users have to be in groups and have permissions
    - apps have to have this service enabled to allow users to log in 
    - SAML federation
        - token provided for a role to do things 
    - AD should be used if wanting to manage users in either AWS Managed AD or on-prem AD
    - external IdPs can be used as well 
    - this whole thing is powered to STS; get authentication via identity provider, sends confirmation to AWS SSO for authentication, then exchanges that for a role 
        - token will be expired over time, and thus the user's ability to assume the role 
- AWS Directory Service
    - managed MS AD
    - actives directory-aware workloads & AWS resources to use managed AD on AWS 
    - use AWS Directory Service for MS AD if wanting actual MS AD in the cloud
    - use AD connector if only needing to allow on-prem users to log into AWS apps & services w AD creds 
    - use simple AD for low-scale, low-cost directory w basic AD compatibility
- AWS Cognito
    - authentication, authorization, user management for web and mobile apps 
    - must know the difference between user pools and identity pools (Kevin recommends 20+ minutes on each)
        - user pools: who is a user
        - identity pools: once we've figured out the who, what they can do

# AWS Partner Certification Readiness: Security - Specialty | Week 5 Exam Strategy 
- question 1
    - starting w encrypted EFS w many files. Company wants to encrypt it & future files. Must be encrypted w regularly rotated keys 
- answer for 1
    - can't modify existing EFS to be encrypted
        - can't encrypt most services after the fact; generally have to create new then copy data over 
    - answer: create KMS CMK + configure auto rotation. Create new EFS & encrypt w key. Use DataSync to xfer existing files to new EFS
    - D: same, but use KMS default service key. Rotation setting is NOT configurable, although they do automatically rotate every 365 days 
- question 2
    - company ensuring compliance encofrcing data retention. Critical data stored w restriction that locks data against future changes for 1 year. Data stored in s3 standard, but rarely accessed. Want to move to archival solution. How to move data MOST efficiently
- answer for 2 
    - lifecycle rules directly from s3 to glacier. Use vault lock policy to enforce compliance. Complete process in less than 24 hours x
- question 3
    - company has KMS CMKs. Some keys have imported key material. keys must be rotated annually. 
- answer for 3
    - enable automatic key rotation + import new key material to a new key; point key alias to reference new key 
    - can't import new key material into existing key
    - doing rotation manually would be annoying
    - don't delete existing keys; keys not remade by default 
- question 4
    - stack deployed w CFn. template specified just enough properties necessary for resource creation & inherited default values from remaining optional values. company reconfigured default values OUTSIDE of CFn. Now want to maintain all settings for properties through template. identify changes made outside of CFn & remediate template to original config. Which solution will meet these req's w least effort
- answer for 4
    - a: update template w values for all properties. use lambda + eventbridge. Run lambda daily
        - it /would/ work, but complicated 
    - b: use the original template (which kinda seems like it doesn't have the new values in it). use lambda + eventbridge to run the original template
    - correct: c: update template, detect drift w AWS Config, configure a config rule to use SSM automation runbook to run the remediation 
    - d: use Config drift detection & run SSM automation runbook. Can't detect drift w/o knowing original properties 
- question 5
    - company uses AWS orgs to manage accts. Want to prohibit use of unapproved services in prod accts. Wants to minimize add'l management overhead as number of accts increases
- answer for 5
    - when seeing this, think about OUs to segregate accts, and SCPs to reduce scope of access 
- question 6
    - company builds & maintains customer products in separate accts. security team overwhelmed w incident report. How to efficiently determine access to resources granted to external IAM identities & what sensitive info stored in S3 is publicly accessible
- answer for 6
    - AWS orgs, add customer accts as members in security hub. Turn on Macie, AWS IAM access analyzer, and CT in company acct + all accts. Use security hub to analyze findings 
    - cloudtrail needed for access analyzer 

# Practice Exam Review
- S3 & CloudFront
    - company wants CloudFront w two origin buckets. Some AWS resources need access to bucket one, but not the other. CFt needs access to both buckets
    - create a CFt Origin Access Control (OAC) to associate w CFt distribution only
        - create a bucket policy for bucket one that allows read access to AWS resources + OAC
        - create bucket policy for bucket two that only allows read access to OAC 
- IAM roles & global condition context keys 
    - company allowing third party contractor to assume only certain roles. Wants to ensure roles can only be assumed if MFA is in use
    - aws:MultiFactorAuthPresent is only used by temporary credentials, i.e. roles
    "Effect" : "Deny",
    "Condition" : { "BoolIfExists" : { "aws:MultiFactorAuthPresent" : "false" } }
    - This is the best way to check if temporary credentials, i.e. a role, is using MFA. If the role assumption is not, or if long-term credentials are trying to be used (i.e. IAM user) then this would flat out deny them
- AWS service catalog
    - gives users ability to create & manage catalogs of IT services that are approved for AWS. Can be a way to further limit access of devs w/o implementing (or in addition to) SCPs
- CloudFormation StackSets
    - extends capability of stacks b/c gives users ability to create, update, or delete stacks across multiple accts + regions w a single operation
    - can use admin account to define, manage, and use CFn template as basis for provisioning stacks 
    - delegated admin is the only account that is allowed to use StackSets to deploy to specific OUs or individual accounts. 
        - dev accts cannot access CFn SSs
- AWS Private Marketplace
    - can be build on top of AWS marketplace
    - gives admins ability to create & customize digital catalogs of approved independent software vendors & products that confirm to the company's in-house policies 
    - AWSPrivateMarketplaceAdminFullAccess is the policy required to set up the marketplace in the first place 
- GuardDuty & SSM
    - detects comms to know C2 endpoint from EC2 instance. Instance is running vulnerable version of common web framework. Ops team wants to quickly identify which other compute resources have that framework version installed
        - config cannnot discover the version of an installed framework
            - can provide detailed view of config & compliance status of resources in acct 
        - Inspector network reachability inspector 
            - looks for security vulnerabilities of instances on a network access basis
        - SSM inventory
            - collects metadata from managed nodes. can query data to find which nodes run what versions of the framework
        - RAM (resource access manager)
            - used to securely share resources created in one acct w roles & users in that acct + other accts 
- KMS
    - company is expanding to second region. Want to use the same key material in the new region. All existing and new EBS volumes must use same key across regions 
        - cannot convert a single region key into a multi-region key
        - cannot change the KMS key that is associated w existing encrypted volume 
        - Create new multi-region KMS key (in the original region), create a replica key in the second region. Use the replica key to encrypt all EBS volumes in the second regions. Use snapshots of the EBS volumes in the first region to create new EBS volumes (in the first region) that use the new multi-region key 
- ECS/ALB/Cost explorer
    - ECS services ran behind ALB. ECS services deployed in private subnets. Services need to be frequently updated & require indirect internet access for the updates. Services must be able to communicate among each other. During development, Cost Explorer forecasted high costs for the coming three months. NAT gateway usage had unexpectedly increased. How to identify & resolve the security gap
        - Use cost explorer to view cost data for previous month, group by service and usage type. check for unusual costs. Since they apparently didn't know why costs had increased, need to look at historical cost explorer information
            - able to create monitors in cost anomaly detection & receive SNS alerts (kinda like I do on my account)
        - use VPC Flow Logs & send to S3, then query with Athena. After confirming NAT gateways are the problem, can see what traffic is going to them from where 
        - don't use VPC reachability analyzer; it only works on traffic inside VPC & identifies what component w/n VPC is blocking connection. like traceroute for the VPC 
        - create new internal ALB. register & update web services to use newly-created ALB for internal comms b/w services 
- VPC Flow Logs
    - company set up VPC flow logs w default flow log record format. Want to quickly identify excessive IPv4 requests that got rejected. Least effort solution
        - cannot change flow log record content of an existing flow log. 
        - can publish VPC flow logs to S3 or cloudwatch. In cloudwatch, it'd be easiest to just use a CW metric, rather than trying something with Athena in S3. Cloudwatch can then notify SNS when threshold is exceeded 
- AWS Backups
    - company must back data up every day. Currently experimenting w AWS Backup & default vaults. Must retain backups for at least 1 year. Backups must be available w/n region + another region for compliance reasons 
        - create backup plan that has daily backup frequency, default vault in main region for backup + default vaule in second region as destination backup w retention period of a year. Apply backup vault lock to the default vault in the second region that has a min retention period of 1 year for the recovery points 
            - AWS Backup Vault Lock permanently enforces retention periods & prevents early deletions by privileged users (including root)
            - a backup plan requires selecting a backup vault from same region. Cannot directly write backups to a second region 
            - vault access policies restrict user access only to AWS backup APIs
- VPC peering
    - company added new instance to a peered VPC where traffic was otherwise able to travel b/w. New instance cannot be reached by existing instances in other VPCs. solution w least effort 
        - use VPC reachability analyzer to create path w new EC2 instance as destination & EC2 instance in the other VPC as the source. View results to determine which component is blocking comms 
        - since there's no indication that the new VPC can't reach other instances, it should be used as destination, not source 
        - VPC flow logs + S3 + athena could potentially work, but lot more effort than reachability analyzer 
- S3 
    - planning to create versioned s3 bucket to store sensitive data. multiple apps will access data. When objects no longer required, specific authenticated users should delete them. Those users get the appropriate permissions. Even if users delete some objects, company must maintain all versions of s3 bucket w/o any modification for a minimum of 7 years
        - enabling MFA delete for bucket using root is not secure since root MFA would have to be shared
        - S3 Object Lock in compliance mode
            - object lock can help protect objects from deletion or overwriting for a fixed amount of time
            - in compliance mode, no user, including root, can overwrite or delete a protected object version until retention period expires
            - when enabled, versioning automatically activated
            - in governance mode, no user can overwrite or delete protected object, but any user w the correct perms can alter the retention settings or delete the object
        - aws:MultiFactorAuthAge is for all types of MFA requests, not just temporary, and identifies if the request has MFA. IF it didn't, would evaluate to null
            "Condition": { "Null": { "aws:MultiFactorAuthAge": true }}
            - if Null in the condition evaluates to null, i.e. no MFA age indicating no MFA usage, then it evaluates to true. If the condition is true, then the statement (of deny) applies to it
- IAM 
    - access key compromised & EC2 instances launched unexpectedly. What actions to take to minimize impact 
        - deactivate the compromised IAM access key for the IAM user 
            - do not delete the key, test apps with a new key, then delete the key 
        - create point-in-time EBS snapshots for volumes attached to new instances & isolate the new instances (for offline forensics)
        - use CloudTrail to discover any add'l actions performed using the compromised access key
- log network traffic to ALB behind Web ACL
    - company must log all network traffic flowing to app. Admin must analyze logs in as close to real-time as possible. Must block an IP address that attempts HTTP flood attack
        - configure web ACL logs, send logs to S3. Write lambda function to query Athena & analyze logs. Add suspicious IP addresses to Denied IP set of web ACL. 
            - IP set: collection of IP addresses & IP address ranges that can be used together ina  rule statement
                - can reference up to 10k CIDR ranges each 
        - VPC flow logs won't work, since they're only for network interfaces w/n VPC. Also collect data in an aggregation interval & is not real-time
        - SG rules won't work; max 50 rules allowed 
        - listener rules won't work; only 100 rules allowed (and not recommended to use for traffic blocking)
        - in the event of an HTTP flood or other attack, app may not be available, and app logs would not be helpful to look at 
        - WAF logs can be sent to CW, S3, KDF
- MS AD
    - company wants an AWS solution to manage new and existing users on AWS, and to move from on-prem MS AD. Must support MFA
        - Use AWS Directory Service for MS AD. Use Active Directory Migration Toolkit (ADMT) to migrate users from on-prem MS AD. 
            - ADMT can migrate users from on-prem AD to AWS managed MS AD. AWS Managed MS AD supports MFA. 
        - Using IAM Identity Center is used for synchronizing MS AD deployments, but cannot migrate identities from existing AD 
        - Using AWS Directory Service w AD connector just redirects requests to on-prem MS AD. Doesn't even cache info
        - AWS DS w Simple AD doesn't support MFA
- AWS Orgs
    - company has hundreds of AWS accts in dev/test/prod OUs. Devs have full admin access to dev accts. Company wants to allow only certain EC2 instance types to be used w/n dev OU. How to prevent dev accts from launching unapproved EC2 instance types
        - create SCP to denty ec2:RunInstances for instance types that aren't in an approved list & attach to dev OU 
- IAM
    - company implementing MFA w FIDO security keys. Security admin tasked w configuring MFA for all IAM users. Must verify the right type of MFA is configured before distributing the devices to the correct employees 
        - use the IAM console to configure security key device for each user. Verify all IAM users have MFA configured from the users page in the IAM console 
        - can't use a credential report b/c it only lists TRUE or FALSE under mfa_active, and couldn't confirm it's FIDO or not. 
        - can't use CLI; FIDO devices can only be enabled in the console 
- CloudFront
    - company wants to filter out unauthorized requests based on JSON web token in the query string of a request to CFt that goes to ALB in front of EC2
        - create a CloudFront function & attach to CFt distribution that has the viewer request event type. Use the function to validate JWT value
            - CFt functions are deployed at edge location & can be used to modify traffic. Infinitely scalable, performant, and secure
        - Can't use WAF web ACL b/c it cannot process or validate JWT value. Is able to filter traffic based on presence of JWT query string 
        - lambda@edge is a lambda function that can customize the content that CFt delivers, but they sit behind CFt; requests go through CFt first; if content is available in cache, then the lambda@edge function wouldn't be triggered 
- EBS volumes
    - wants to set up an automated solution to scan EBS volumes for malware at scale. Security consultant creates Amazon EventBridge rule + sets CW logs log group as target for the rule 
        - use GuardDuty. Configure eventbridge to match GD finding when type is 'Execution:EC2/MaliciousFile' or 'Execution:EC2/SuspeiciousFile' <- those are GD finding types
        - there is no service called EC2 or EBS Malware Protection 
        - Amazon Inspector does not have a feature named Malware Protection 
            - also, doesn't scan for the presence of malware itself 
            - inspector finding types include 'PACKAGE_VULNERABILITY' and 'NETWORK_REACHABILITY'
- ECS
    - company runs critical workload on fargate ECS. ECS task refernces a sensitive variable & the variable must be rotated every 12 monhts. Most secure way to do that 
        - create key-value pair for var in AWS Secrets Manage. Reference it in the env vars section of container definitions in ECS tasks. Use 'ValueFrom' option for the var. Add full ARN for secret to container definition. Configure rotation in secrets manager
            - in fargate, not all ECS task definition parameters are available 
            - valueFrom expects a string of arn of a secret, or the local location of a secret 
- CloudFormation StackSets
    - company uses AWS Orgs to manage accts. security team defined security controls in CFn template. security team must deploy controls in all accts that belong to specific OUs in org
        - enable trusted access w/n org for CFn StackSets. Register a security acct as delegated admin for SSs. Use SSs in the security acct to deploy custom controls as stacks in the appropriate OUs
            - recommended to delegate features of security services to other accts than just the organizational billing (i.e. management) acct 
            - when trusted access is activated, SSs creates the necessary IAM roles in the org's management acct + target (member) accts when creating SSs
                - only account admin in management acct has perms to activate trusted access 
            - able to grant self-managed perms to security acct to perform SSs ops. However, is labor intensive b/c it requires creation of roles in sec acct + each member acct. Better to use trusted access 
- SSM 
    - lots of EC2 instances in VPC that has an S3 endpoint configured. Instances have SSM agent + CLI installed. Not all have internet access. Critical vulnability exists in the OS of the instance. OS vendor is creating a patch. Company must deploy patch on all instances w/n 1 day of release
        - download patch from OS vendor to S3 bucket. Create SSM document that defines commands necessary to install patch. Use SSM run command to apply patch
            - using lambda + SSM patch manager predefined patch baseline would be more complicated, and predefined patches include 7 day approval period before new updates are released 
            - trusted advisor doesn't do this; can only provide recommendations on following best practices, but does not get data on installed patches on instances
- S3
    - want to ensure S3 compliance. When buckets become noncompliant, must receive email w bucket name, region, and time of noncompliance. Security Hub + Config have been activated. SNS topic w email subscribed has been created. Now what to do? 
        - in Config, add s3-default-encryption-kms managed rule to the list of enforced rules. Set rule to run when S3 bucket is created or edited
            - can't define an hourly frequency for config rules to run. 
        - create EventBridge rule that has SNS topic as target & an event pattern JSON
            - security hub findings can't be defined in JSON; SH collected security data from AWS accts, services + 3rd party products to analyze security trends & identify high priority security issues
                - findings are viewed from other resources, rather than set up directly in SH
            - in config, can use JSON to define events, but setting a remediation action to AWS-PublishSNSNotification wouldn't send all the desired data, would only pass ResourceId
- AWS Orgs
    - How to manage tag enforcement at scale 
        - config tag policies at org level & create resource creation request guardrails using SCPs 
            - tag policies: offer centralized tag management at scale & integrated w AWS orgs
            - resource reqest guardrails needed b/c some services don't support tags 
            - AWS config can flag non-compliant resources, but cannot enforce tagging
            - in RAM, tags can be applied to a resource share, but not to resources in the share
            - resource groups tagging API allows for programmatic access to tagging functions of AWS resources, but does no enforcing
- IAM
    - devs need to create IAM roles + policies w/n dev AWS accts during IAM policy dev process. All teams receive different degrees of access through AD federation. Security team needs to ensure that devs don't have ability to grant themselves add'l unapproved access to IAM roles 
        - Use IAM permissions boundaries for the federated roles that devs use
            - can be applied to a role. Create a maximum permission that the role can use. No actions beyond permission boundary permitted
            - SCP is not best in this scenario. It is used to control max perms for entire account. Will NOT effectively control max perms for specific role w/n accts 
            - session policies injected inline at the time a user assumes a role. Cannot apply to the role as a whole. Session policies only affect the specific session
- AMIs
    - infosec mandated only approved AMIs can be used. How to enforce mandate
        - deploy Config rules & check all running instances for compliance 
- secrets manager
    - RDS DB accessed by lambda functions. All the functions use the same DB user to access DB. Passwords must be rotated every 90 days. When password was manually updated, the functions broke b/c they were referencing env vars for the credentials. implement a secure pw storage + rotation solution 
        - create RDS secret in Secrets Manager to store credentials. Create lambda rotation function to do auto rotate and schedule it to do every 45 days. Use an alternating-users rotation strategy. update functions to retrieve credentials from SM
            - having two users available to access app at any time avoids potential downtime during rotation process. User pwds are rotated in an alternating pattern. apparently also prevents the DB user from resetting its own password
            - having a single-user rotation strategy does not prevent lambda function of the app from being able to change password(?) + low risk of db denying access at time of pw rotation
- S3
    - encrypted s3 bucket. app dev has IAM policy that allows full access to bucket, but is unable to access objects in bucket 
        - the bucket policy explicitly denies access to app dev 
            - not ACL b/c they are legacy control & policies should be used instead. ACL can control access to buckets or individual objects for specific AWS accts or groups
            - not KMS perms b/c the KMS key doesn't need to list app dev as admin for dev to access bucket. Dev WOULD need appropriate KMS perms to use key for encryption + decryption of objects 
            - S3 bucket policy does not need to explicitly grant access to dev if they've got an IAM policy allowing access 
- GuardDuty
    - company uses AWS orgs to manage accts. Collects lots of logs. Wants to implement solution to detect anomalous activity in accts. Security team must get notifications for findings. lowest effort solution.
        - configure GD for the org. designate security team's acct as delegated admin. use CW events (EventBridge) to subscribe to findings of suspicious activity
            - GD creates event for CWE when any change in findings takes place. 
                - finding changes that will create event include newly generated findings or newly aggregated findings 
            - GD notifications to SNS would not contain info about whether query detected suspicious activity. GD does not need to and cannot copy logs from other AWS accts to conduct analysis & generate findings
- CloudHSM
    - company has web servers that implement end-to-end HTTPS sessions. They have invested in the generation of key materials for this purpose. But process is computationally heavy & affects web servers. Company wants to offload TLS processing. Want to import & control key materials on AWS. keys should only be available during standard business hours 
        - create CloudHSM cluster that has HSMs in multiple AZs. Import key materials into cluster. Create & schedule AWS Lambda functions to remove all HSMs & to add appropriate HSMs in the cluster as required 
            - KMS only supports symmetric encryption keys; need asymmetric keys to offload TLS processing 
            - CloudHSM backups cannot be explicitly initiated. Also isn't a regional service 
- VPC architecture
    - company has three-teir architecture, but web server is timing out. Using NACLs, and only inbound traffic allowed
        - edit rule for DB tier to only allow 3306 from app tier. Add a rule to the NACL that allows outbound traffic on all ephemeral ports to the private IPv4 address of app server 
            - by default, new custom NACLs BLOCK ALL TRAFFIC
            - web tier shouldn't be able to directly access DB tier
- GuardDuty
    - company subscribed to third-party threat intelligence list uploaded to S3. How to use the list across all company AWS accts 
        - ensure GD is in administrator-member config. Add threat list to admin acct refercing the S3 object that contains the threat list
            - only need the one admin acct accessing the S3 bucket 
- IdP w CI/CD pipeline
    - company uses external CI/CD system to manage resources in AWS. The system uses access key of an IAM user & policy attached directly to user. Company had a security breach that publicly exposed creds. Creds weren't frequently rotated. Just implemented external IdP that supports OpenID Connect (OIDC). How to create secure auth solution that uses the IDP
        - Create an IAM OIDC identity provider. Register CI/CD system as audience to external IdP. Add CI/CD clientID to new IAM OIDC identity provider. Assign a new role to the eIdP that has appropriate perms. Configure CI/CD pipeline to assume role using AssumeRoleWithWebIdentity action
        - CI/CD must be registered to eIdP instead of to the IAM ODIC. The CI/CD must be part of the audience of the eIdP to get creds from there. ClientID of CI/CD system must be added to IAM OIDC identity provider 
            - when a thing is associated with an audience of an IdP, it receives a client ID, which is then provided to the IAM OIDC provider console 
- EC2
    - EC2 instances compromised multiple times. Want to capture memory dumps of compromised instances for future analysis. Just receive notification that EC2 instance running a windows AMI is compromised. How to collect memory dump for forensic analysis
        - download and run EC2Rescue for Windows Server utility from AWS 
            - can capture memory-dump files that exist on the instance. Can also capture event logs, config logs, and SSM agent logs
            - SSM Agent does not interact w memory dumps; instead, it processes requests from SSM service and runs them on the EC2 instance 
            - rebooting an instance erases RAM
- ECS
    - mission-critical web apps ran using ECS on EC2. security teams wants to inspect content of all traffic that is related to instances. inspection should be done passively & not affect network performance 
        - use VPC traffic mirroring + Gateway Load Balancer w security appliances to analyze the traffic 
            - packets from all network interfaces in the cluster can be mirrored to GWLB. GWLB can distribute packets to security appliances that run on EC2 instances for deep-packet (i.e. content) inspection to provide an out of band solution 
            - gateway load balancer help easily deploy, scale, and manage third-party virtual appliances 
            - VPC flow logs do not inspect content 
            - directly using a GWLB in-line with the traffic would impact network performance 
- IAM
    - users are able to assume an IAM role that allows full access to EC2 and RDS. A user who's able to assume that role also needs full S3 access. Best way to do that
        - create new IAM role that grants full access to S3, EC2 and RDS resources. Have user assume new role 
        - can't use session policy b/c it limits perms IAM entities already allow; not able to add more perms 
        - can't assign S3 perms to user b/c when they assume role, their own credentials are NOT used
- Control Tower + Guard Duty
    - team uses CT to organize accounts + GD to monitor resources. Team must design automated detection and rememdiation process for GD findings. Process should gather forensics on instance to understanding findings more completely. All instances run in ASGs
        - create EventBridge rule to detect desired GD findings. Set up lambda function as target to capture metadata on instance. Turn on termination protection on instance. Isolate instance by putting on fully restrictive SG. Detatch instance from ASGs. Deregister from any ALBs. Snapshot volumes. Quarantine instance. 
            - can't use Detective, which processes TBs of event data records to identify root cause of security findings or suspicious activities, but CANNOT perform actions against EC2 instance 
- KMS
    - app ran across multiple EC2s. App must encrypt all data. Must rotate key every 30 days 
        - use an alias that targets a customer managed key. Create new key every 30 days + update the alias
            - can use the alias to refer to specific key in app code. During the rotation, in KMS can update alias to use a new KMS key 
            - can't use KMS managed key b/c key rotation interval can't be user-adjusted. 
            - for CMKs, can enable rotation, but automatically can only be done once a year 
            - can only import key material into a KMS key once 
- IAM
    - unauthorized activities were performed by user's IAM access key & malicious activity may have occured. What to do to reduce risk? 
        - Use AWS IAM console to identify IAM user associated w access key. Generate a credential report. Use data in credential report to identiy the IAM user. Deactivate all access keys associate w user. Create deny all IAM policy. Attach policy to user 
            - can't use IAM Access Analyzer to identify user that is associated w access key credentials; it identifies AWS resources that are shared w external entities, validate IAM policies, and generate IAM policies based on CT activity
            - don't delete the user
- S3 
    - company has unencrypted S3 bucket w millions of objects, some of which contain PII. multiple apps access the objects. Security engineer must provide report that identifies sensitive data. Must also ensure all current & future objects are encrypted 
        - Run Macie discovery job w appropriate managed + custom data identifiers. Review Macie findings to generate report. Turn on default encryption for S3 bucket. Use S3 inventory report + S3 Batch Operations job to encrypt existing objects in bucket 
            - S3 batch operations job w a copy operation can copy existing unencrypted objects + write the objects back to the same bucket as encrypted objects 
            - need custom data identifies to collect customer account numbers 
            - creating a new bucket and copying everything over would be more effort
- Security Hub
    - company wants to establish central dashboard. It should aggregate security findings from AWS service + third party solutions across accts and regions. also want a SIEM. How to do w least operational overhead
        - use AWS Security Hub as a single aggregation point. Use Amazon OpenSearch Service as SIEM w SH
            - use SH w OSS to store findings for longer than 90 days
            - can aggregate findings across multiple accts w/n one or multiple orgs
            - can correlate SH findings w each other + log sources 
            - SH is a cloud security posture management service and not SIEM solution
                - SIEM solutions generate security findings + offenses. Must integrate SH w other services to see the data 
            - using a third-party SIEM would have lots of operational overhead 
- S3 
    - company wants to use KMS CMK to encrypt all buckets in main region. Need a solution that will detect & rememdiate noncompliant S3 buckets & notify team of noncompliance. How to do w least operational effort 
        - configure Config managed rule s3-default-encryption-kms. Create SSM automation runbook that turns on KMS encryption for the noncompliant buckets and publishes SNS message to security team. Assign runbook as auto remediation for config rule
- IAM/secrets manager [this one was SUCH a reading compehension one]
    - company has two accts. app exposes an API on an EC2 that runs in Acct1. Company secures API by requiring API key. Key not changed frequently. EC2s in Acct2 must have ability to use IAM role in Acct2 to allow instances to access API key that's required to make calls to app's API
        - Store API key as encrypted secret in Secrets Manager using a CMK in Acct1. Configure resource-based policies for the secret + key that allow IAM role to use the secret and key. Attach identity-based policy + a trust policy that allow the use of the secret & the key in Acct1 to the IAM role 
            - SM supports cross-acct access for secrets encrypted by KMS. Requires updates to resource-based policies for the secret + the key
            - can only change resource-based policies on CMKs 
- VPC Flow Logs
    - company uses VPC flow logs to config multiple flow logs + publish data to S3. Use athena to evaluate log data for security threats. some queries that used specific fields in log data said columns could not be resolved. How to fix
        - replace existing VPC flow logs w new flow logs. Use a custom log record format to include the specific fields in addition to other relevant fields 
            - cannot modify existing flow log format 
            - custom log record format is required to include vpc-id and subnet-id fields in data (default format doesn't include those)
- ECS
    - vulnerability discovered that exfiltrates data on port 5353 in batches at random intervals. While patch is being developed, how to identify compromised hosts & stop egress of data 
        - create CW custom metric on VPC flow logs identifying egress traffic on port 5353 (to identify compromised hosts). Update NACLs to block port 5353 outbound (to stop egress)
        - can't use inspector, which only performs package vulnerability scans on container images, but doesn't include egress access on a specific port 
            - to scan network for instances where port is open, would have to run inspector network reachability package to identify open ports; to get add'l info about processes running on the port, would have to install inspector agent 
        - can't use CT, since they don't contain traffic port info. SG rules can't deny traffic 
- IAM 
    - company outsourcing operational support to external company. How to allow access w minimal overhead
        - federate IAM w external company's IdP. Create IAM role & attach policy w necessary perms
        - cognito wouldn't be applicable, since it is for business-to-consumer web & mobile apps. If only cognito actions were denied in the access role, then the external company would have basically keys to the kingdom
        - federated identities can only assume a role, and roles cannot be added to groups 
- CloudTrail/Athena
    - centralized S3 bucket collects CT logs from hundreds of accts. Create a solution that allows running ad-hoc queries against CT logs dating back to the start of logging. least admin overhead
        - Athena. literally what it's designed for
- IAM
    - auditors from account B w unique IAM users need access to account A. Auditor-Alice requires read-only access to AcctA S3 bucket. Admin of AcctA uses console to create S3Audit IAM role that gives AcctB read-only access to S3 bucket. AccB admin attached policy to Auditors group to assume the role. How to improve access control most securely
        - modify trust relationship to the S3Audit role to have the following principle
            "arn:aws:iam::{AccountB}:user/Auditor-Alice"
            - for a cross-acct IAM role, default trust policy gives ALL users in the other acct ability to assume role. Increase security by restricting default trust policy to authorized users
- Direct Connect/VPN
    - company needs dedicated & isolated internal channel to connect on-prem site to s3 buckets. requires data in transit to be encrypted w IPsec
        - use DX link configured w public virtual interface to establish connection. Use site-to-site VPN tunnel w DX link to comply w IPsec
            - b/c connection is to a public service, such as S3, must use public VIF
            - DX does not support IPsec encryption by default
            - private VIF is for connecting to VPC
- SSM parameter store
    - app hosted on EC2. should be able to access secure strings stored in SSM parameter store. When app tries to access secure string value, it fails
        - EC2 instance role must have decrypt permissions on KMS key used to encrypt secret
            - SSM PS is NOT used to decrypt the KMS key
        - EC2 instance role must have perms to read the parameters in SSM PS
- lambda
    - lambda function outputs print statements to log for debugging. During tests, dev able to view log output in test tab. However, can't see logs in CW
        - update function execution role to allow the function to create CW logs log group + log stream & upload log events to stream
            - lambda needs the permissions, not the dev
        - lambda functions can have resource-based policies, but they govern permissions to other AWS accts + service to invoke the function 
- KMS
    - EC2 instances in acct deployed across two regions. One in canada, one in US. must encrypt all new EBS volumes + snapshots. Must protect encryption keys from deletions. Prefer to use AWS service. Must have ability to share EBS snapshots in the home region w other accts in same region for troubleshooting. Security admin plans to implement EBS encryption by default in both regions. least operational effort
        - create & use CMK as default KMS key for EBS encryption. Update policy of CMK to prevent key deletion. Use AWS managed keys as default KMS keys for EBS encryption in the Canadian region 
            - CMKs allow sharing EBS snapshots across accounts 
            - users cannot delete KMS managed keys, so they're protected from deletion by default 
                - using CMKs when not needed & having to add deletion protection is unnecessarily complicated for this specific question
- CloudFront/WAF
    - company runs three web apps. One uses CFt to serve ALB. A plain ALB used for the second app. Uses API gateway w edge-optimized endpoint to serve third app. protect apps & deny requests from known malicious IP addresses
        - create two WAF web ACLs. Associate one web ACL w CFt distribution. Associate other web ACL w second ALB + rest API
            - Web ACLs can be global or regional; use global to protect CFt, use regional to protect ALB + edge-optimized REST API. 
                - cannot associate a web ACL associated w a CFt dist w any other AWS resource type 
- IAM
    - IAM group created w small set of IAM users. Members must have restrcited access to new S3 bucket. Security admin plans to attach policy to group. Admin wants to verify overall effective access before providing access
        - use IAM policy simulator in existing policies mode. Select all existing policies associated w IAM user in group. Create new IAM policy in policy simulator. Run simulation w all S3 actions selected. Repeat this process for each user in group
            - to test policy directly attached to user + new policy, must select all existing policies for IAM user
            - since each user may have different policies, have to do this for each user...
            - in new policy mode, cannot select specific IAM users & existing policies that are attached to those users 
- Cognito/AD
    - company uses MS AD for on-prem & wants to use same mechanism for accessing AWS accts. a dev team wants to launch public-facing app that they need a separate authentication solution for. what combo to meet req's
        - cognito user pools for app auth
        - set up federated sign-in to AWS through ADFS and SAML
        - don't use AD connector, which is a directory gateway used to redirect directory requests to on-prem AD. Can't use AD connector to access apps 
- ECS
    - cluster runs on 25 windows EC2s. need to run script on each instance to make req'd config changes as quickly as possible. how to do it w most secure access to instances 
        - use SSM run command to run script on all the instances
            - run command: gives users ability to remotely and securely manage config of EC2. eliminates need to interactively access instance
            - instance connect uses SSH and doesn't support windows 
            - can't use key pairs and RDP to start sessions b/c key pairs are for getting initial password decrypted + need to add SG to allow the new port 
            - using SSM session manager would require security engineer to connect to each instance individually. it's best to automate and centralize change management
- CFt/firewall manager
    - company uses AWS orgs to manage three accts. Each acct has several CFt distros. Must protect all existing & new CFt distros to meet security reqs. company creates AWS WAF web ACL w appropriate rules in one acct. least effort solution
        - create AWS Firewall Manager security policy for AWS WAF in same acct as existing web ACL. include existing web ACL in security policy. config policy action to auto remediate any noncpompliant resources. Include all CFt distros in FM policy scope 
            - able to download web ACL as JSON document, but don't need to do so for this solution
- VPC architecture
    - company has three-tier web app. Recently discovered that second tier was unintentionally communicating w another EC2 in a peered VPC. prevent this comm in the future
        - add outboound rule to AppSG to allow only traffic on port 1521 that is destined for the IP subnet of the DB instances 
        - other options had only one-sided NACL rules, or outbound deny rule on SG
- CT
    - multiple prod accts. each acct have CT configured to log to central S3 bucket. Two prod acct trails aren't logging to the bucket. troubleshoot
        - verify s3 bucket policy allows access for CT from prod AWS acct IDs. 
            - to receive log files for org trail, bucket resource-based policy must be updated correctly
        - confirm in CT console that each trail is active & healthy 
        - confirm in CT console that s3 bucket name is set correctly
            - CT console will display target bucket name
        - in this particular question, AWS orgs not used, so global config for accts not possible
            - it is possible in an organization, in the management/admin account, w sufficient permissions, to create an org trail & specify s3 bucket location. can enable log file validation and sns notifications
        - log file prefix is just the prefix used for the logs, not the bucket the logs go to
        - no need to make another CT if it's a permissions issue
- CT
    - aws orgs used to manage multiple accts. security has separate acct. company relies on CT log files to prove compliance w regulations. stores log files in S3 buckets in each acct. recently, CT log files deleted in a non-management acct. CT was turned off for some services in acct. solution that prevents deletion of log files & modifications to CT settings. least effort
        - create encrypted S3 bucket. configure object lock + MFA delete in the org's mgmt acct. create org trail in mgmt acct 
            - users in member accts will not have ability to make mods to trail
- EKS
    - EKS app in private subnets across AZs. app uses public internet to connect to AWS partner's custom DB solution on TCP/IP 27017. Devops engineer must secure app & ensure db connections don't leave AWS network. Connections must be accessible only by EKS cluster prods. traffic across the VPCs must be restricted to DB connections only. Partner offers PrivateLink + VPC peering options. Partner provides IPv4 CIDR range + endpoint service name for config
        - create PL interface endpoint for the provided endpoint service w/n EKS cluster VPC. Assign SG to interface endpoint that allows inbound connections from EKS pod SG. update EKS pod SG to allow outbound connections to interface endpoint on 27017
            - when using PL, VPC endpoints can make private connections from a VPC to supported AWS services, services that other AWS accts host (VPC endpoint services), and PL ready partners. PL connectors have unidirectional access only. 
                - since EKS must initialize the connection, have to allow outbound traffic, and allow the stateful nature of SGs cover the rest 
            - EKS cluster VPC resources must initialize DB connection to the endpoint service 
- Cost Anomaly Detection
    - company uses aws orgs to manage 50 accts. security team notified acct admin of data exfiltration activities by EC2 in member acct. Increased expenditure resulted from the incident. Security team must identify similar expenditure fluctuations in each member acct so acct admins can take immediate action
        - use AWS Cost Anomaly Detection to create cost monitor that uses AWS services monitor type in each member acct. Create alert subscription w individual alerts to notify appropriate acct admins
            - CAD uses ML to continuously monitor cost & usage to detect unusual spends. Cost monitor can analyze all AWS service independently or by member accts, cost allocation tags, or cost categories
                - linked account cost monitor evaluates only the total spend of an individual member acct or group of member accts. 
                    - does not evaluate AWS services independently for anomalies 
- Service Catalog
    - mgmt concerned when users launch products from service catalog, elevated IAM privileges will be required to create resources. mitigate concern
        - add launch constraint to each product in portfolio
            - launch constraints specify IAM role that SC assumes when end user launches, updates, or terminates a product
            - used to assign role to portfolio so individual user does not need add'l privileges to create resources
        - template constraints can be used to limit options available to end users when the launch a product. Do not specify assumed role 
        - SC tag update contrains are used to allow/disallow end users to update tags on resources 
- Macie/Security Hub
    - company uses macie to exam s3 buckets across regions. security admin inspects all policy & sensitive data findings in each region separately & wants to unify all findings in home region. How?
        - configure security hug in each relevant region, w home region as aggregation region. Update publication config in Macie to publish policy & sensitive data findings to SH. Use S3 buckets w sensitive data SH managed insight to inspect findings 
            - by default, only policy findins are automatically published to SH; sensitive data publishing must be configured 
- AD/IAM
    - company wants to access AWS resources by using identities & groups defined in existing MS AD. What must company create in its AWS accts to map perms for AWS services to AD user attributes
        - IAM roles
            - can map user attributes in AD to IAM roles. Can create & attach policies to the roles based on job roles & control access to AWS resources
        - not IAM groups or users. Cannot be used to federate users
        - not w access keys, which are created at time of STS call, but invisible to the user 
- S3/Config
    - unapproved changes had been made to s3, so aws config was set up to record config changes to s3 buckets. s3 config changes are being made, but no SNS notifications are being sent. how to resolve issue
        - configure policies attached to S3 buckets to allow AWS config to record changes to the buckets 
            - don't use ACLs unless control to each object in a bucket must be individually managed 
        - assign AWSConfigRole managed policy to the AWS config role
            - config requires IAM perms to record config details about resources
                - IAM users don't need admin access to config, plus need resource-based policy to grant access to AWS config
- GuardDuty
    - moving from ec2-hosted malware detection to GuardDuty Malware Protection ot scan for malware, automatically isolate EC2 instances, and preserve evidence of malware. Evidence of malware should be stored in attached EBS volumes upon detection
        - configure snapshots retention setting in Malware Protection general settings
            - can turn on snapshot retention to save EBS snapshot indefinitely when malware is  detected
                - don't need lambda to do it since snapshot already created during malware scan
        - create AWS lambda function to isolate EC2 instance if GD MP finding is received
            - lambda function can isolate instance by invoking a no inbound/outboundd SG rule 
        - can exclude resources w tag named GuardDutyExcluded = true (not helpful here)
        - KMS CMK encryption is the only encryption that GD MP supports for EBS. Does not support EBS volumes encrypted w EBS managed key
- CT 
    - must create org trails in mgmt acct 
- GD 
    - create EB events when findings are located, don't need to do anything else 

# AWS Partner Certification Readiness: Security Specialty | Week 5 content review 
- data protection
    - Macie
        - detects growing list of sensitive data types, like PII
        - provides ability to use regex to look for data 
        - sends finding notifications through EventBridge which processes a rule, then can activate Step Functions 
    - KMS
        - behind the scenes, the service used for encryption and decryption
        - only supports symmetric encryption 
        - all key usage logged in CT
            - if key suspected compromised, able to see where it has been used and how 
        - behind the scenes, runs on FIPS 140-2 compliant HSMs 
        - types of keys
            - CMK: created by customer & gives access to creator for rotation
                - rotation optional; auto rotation occurs once/year
            - AWS managed keys: sit in customer acct, created by AWS for services in acct
                - rotated roughly once a year 
            - AWS owned keys: behind the scenes; customers don't touch them 
    - CloudHSM
        - generating & using your own encryption keys in AWS Cloud
        - runs on dedicated hardware
        - supports asymmetric keys as well 
    - Certificate Manager (ACM)
        - privision & manage SSL/TLS certs w AWS services + connected resources 
        - automatically renews and rotates certificates 
    - Private Certificate Authority
    - Secrets Manager
        - manage, retrieve, rotate credentials, keys, and secrets
        - everything in here always encrypted by KMS 
        - avoid hard-coding access credentials in apps 
    - SSM Parameter Store 
        - does not support rotating secrets 
        - gives option to encrpyt or not
- s3 buckets are now encrypted by default, as of >6 months ago 
- SSM session manager
    - allows approved people log into approved instances
    - works through HTTPS
    - logs everything that happens, i.e. file deletion, creation, etc 
- s3 encryption at rest
    - sse-s3 (server-side)
        - once loaded in environment, gets encrypted
        - key management & rotation handled by AWS
    - sse-kms w CMK
        - get all the upside and downsides of CMK
    - sse-kms w aws-managed keys
        - doesn't get used much, sse-s3 kinda does the same thing 
    - can enforce particular type of encryption 
- AWS Backup
    - centralize & manage backup schedules from on-prem and cloud native envs at organization level
        - can also backup across accts 
        - backup vaults are where backups are stored, and vault can be copied to another acct
            - must be in AWS orgs to do this 
    - backup plans can select different resources on different timeframes 
    - can assign resources by ARN or tags 
    - backup location/storage is managed by AWS; doesn't use S3 
## Management and Governance
- services
    - control tower
        - automate the setup of new AWS multi-cloud envs
        - will set up organization, accts, OUs, accts in OUs, turn on controls 
            - in a pre-approved, best-practice sort of way 
            - automates the IAM roles & perms required to move b/w accts as needed
        - initial deployment
            - creates org, populates structure of org
                - security OU contains the following accts 
                    - tooling (audit) account
                        - all auditing tools, like config 
                        - this would be the delegated admin account for config, GD
                    - log archive account 
                        - all centralized CloudTrail and config logs go to central s3 
                        - the one place where it's known the logs haven't been altered 
                - management OU
                    - contains service catalog and AWS SSO
                - sandbox OU
        - account factory
            - consistently set up add'l accts w/n Control Tower 
            - control how accounts are set up
        - can set up configuration rules in preventive or detective/remediate control categories to further manage compliance in env 
        - can turn on guardrails in control tower that will apply to new accounts 
        - security hub integration w control tower
            - by default, CTwr turns on SH & begins reporting compliance 
        - default OUs CTwr sets up is security, sandbox, and infrastructure OU (and management?)
            - there are lots of other OU options available 
        - cloudformation + stacksets + config/CTwr can ensure consistently created accounts & protect the resources created w/n 
    - orgs
    - config
    - service catalog
        - control who has access to what in setting up new infrastructure
        - can define controls of launching
        - go to the catalog and launch things rather than going to products in the console 
        - integrates w license manager to manage licenses from aws marketplace
        - control how resources are set up
    - well-architected tool
    - cloudformation 
- why use multiple accts?
    - separation of duties, minimize impact of breaches 

# TLG Learning Stream
- missed modules 1-4
## module 5: security in S3, RDS, DDB, EBS
- s3
    - block public access   
    - encryption types: SSE-S3, SSE-KMS, SSE-C
    - access points
    - macie (know of it, not necessarily deep knowledge); recognizes PII + keywords in S3 
    - default encryption: all new objects get encrypted 
    - versioning & MFA delete 
- RDS
    - snapshots
    - encryption & how it's managed 
    - read replicas vs multi-az
- DDB
    - default encryption
    - global tables 
- EBS 
    - encryption, via KMS or KMS CMK
    - snapshots; incremental point-in-time 
- archival data
    - S3 glacier    
        - glacier vaults
        - vault lock policy 